IoT AI 助手使用指南

一、前置准备

1. 执行数据库脚本

在 MySQL 中执行 SQL 文件创建两张表：

-- 文件位置: sql/mysql/iot_ai_assistant.sql
-- 创建 iot_ai_conversation 和 iot_ai_message 表

2. 配置 DeepSeek API Key

在 application.yaml 中已添加了配置项，你需要设置 API Key：

方式一：直接修改 application.yaml
yudao:
iot:
ai:
api-key: sk-你的DeepSeek密钥

方式二：通过环境变量（推荐）
export IOT_AI_API_KEY=sk-你的DeepSeek密钥

DeepSeek API Key 申请地址：https://platform.deepseek.com

3. 配置菜单权限

在系统管理 → 菜单管理中，给需要使用 AI 助手的角色添加 iot:ai:chat 权限。或者在数据库中直接插入：

-- 添加权限标识（根据实际菜单ID调整parent_id）
INSERT INTO system_menu (name, permission, type, parent_id, sort)
VALUES ('AI对话', 'iot:ai:chat', 3, 0, 0);

  ---
二、启动服务

1. 后端：正常启动 yudao-server（Spring Boot）
2. 前端：正常启动 hr-vue3（pnpm dev）

  ---
三、使用方式

登录后，在任意 IoT 页面的右下角会出现一个蓝色悬浮按钮 "🤖 AI 助手"。

1. 点击悬浮按钮 → 弹出 400×600 的聊天面板
2. 点击"开始新对话" → 进入聊天界面
3. 输入问题 → 按 Enter 或点击发送按钮

  ---
四、支持的查询场景（第一期）
┌───────────────────────────┬────────────────────────────────────┐
│       你可以这样问        │            AI 会做什么             │
├───────────────────────────┼────────────────────────────────────┤
│ "帮我查看所有建筑"        │ 调用 list_buildings 查询建筑列表   │
├───────────────────────────┼────────────────────────────────────┤
│ "1号楼有哪些电表？"       │ 先查建筑ID，再调用 list_meters     │
├───────────────────────────┼────────────────────────────────────┤
│ "查看电表 xxx 的最新读数" │ 调用 query_meter_data 获取最新数据 │
├───────────────────────────┼────────────────────────────────────┤
│ "1号楼昨天的用电量"       │ 查建筑→查电表→查历史数据           │
├───────────────────────────┼────────────────────────────────────┤
│ "今天的能耗总览"          │ 调用 query_energy_overview         │
├───────────────────────────┼────────────────────────────────────┤
│ "按建筑统计本月能耗"      │ 调用 query_energy_statistics       │
├───────────────────────────┼────────────────────────────────────┤
│ "各类型能耗占比是多少"    │ 按能源类型统计                     │
└───────────────────────────┴────────────────────────────────────┘
AI 会自动进行多轮 Tool 调用：比如用户说"1号楼的用电情况"，AI 会先查建筑列表拿到建筑ID，再查该建筑下的电表，最后查询能耗数据。

  ---
五、交互特性

- 流式输出：AI 回答逐字显示，不用等全部生成完
- Tool 调用提示：查询数据时底部显示 "正在查询: xxx..."
- 对话历史：自动保存，下次打开可继续之前的对话
- 多对话管理：支持新建、切换、删除对话
- 快捷提问：新对话时有3个预设问题可点击

  ---
六、注意事项

1. 只读操作：AI 助手只能查询数据，不能修改设备/告警/规则
2. 租户隔离：每个租户只能查到自己的数据
3. DeepSeek 模型：默认使用 deepseek-chat，也可在配置中换成其他 OpenAI 兼容模型
4. 超时时间：SSE 连接超时 120 秒，复杂查询可能需要多轮 Tool 调用
