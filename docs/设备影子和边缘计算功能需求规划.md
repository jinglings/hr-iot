# 设备影子和边缘计算功能需求规划

## 文档信息
- **创建时间**: 2025-11-18
- **模块**: yudao-module-iot
- **前端目录**: hr-vue3/src/views/iot/
- **版本**: v1.0

---

## 一、设备影子（Device Shadow）管理界面

### 1.1 功能概述

设备影子是设备状态的虚拟表示，用于解决设备不在线时的状态同步问题。它为应用程序和设备之间提供了一个可靠的中间层，即使设备离线，应用也可以查询和设置设备状态。

### 1.2 核心概念

**设备影子包含三个核心部分**：
- **Desired（期望状态）**：应用程序期望设备达到的状态
- **Reported（上报状态）**：设备实际上报的最新状态
- **Metadata（元数据）**：包含状态更新时间等信息

### 1.3 页面结构

```
hr-vue3/src/views/iot/shadow/
├── index.vue                    # 设备影子列表页
├── detail/                      # 设备影子详情页
│   ├── index.vue               # 详情主页
│   ├── ShadowStateView.vue     # 状态视图（期望/上报/差异对比）
│   ├── ShadowHistoryView.vue   # 历史记录视图
│   └── ShadowConfigView.vue    # 影子配置视图
└── components/
    ├── ShadowJsonEditor.vue    # JSON编辑器组件
    ├── ShadowDiffViewer.vue    # 状态差异对比组件
    └── ShadowSyncStatus.vue    # 同步状态组件
```

### 1.4 功能需求详细设计

#### 1.4.1 设备影子列表页 (index.vue)

**功能点**：
1. **设备列表展示**
   - 显示所有已启用设备影子的设备
   - 支持按产品、设备名称、状态筛选
   - 显示设备基本信息：设备名称、产品、在线状态、影子同步状态

2. **影子状态概览**
   - 同步状态标识：已同步、未同步、部分同步
   - 最后更新时间
   - 期望状态与上报状态的差异数量

3. **快捷操作**
   - 查看设备影子详情
   - 启用/禁用设备影子
   - 清除设备影子
   - 强制同步

4. **批量操作**
   - 批量启用设备影子
   - 批量禁用设备影子
   - 批量清除影子数据

**数据字段**：
```typescript
interface DeviceShadowVO {
  id: number                    // 影子ID
  deviceId: number              // 设备ID
  deviceName: string            // 设备名称
  productId: number             // 产品ID
  productName: string           // 产品名称
  enabled: boolean              // 是否启用影子
  syncStatus: number            // 同步状态: 0-已同步, 1-未同步, 2-部分同步
  desiredVersion: number        // 期望状态版本号
  reportedVersion: number       // 上报状态版本号
  lastDesiredUpdateTime: Date   // 期望状态最后更新时间
  lastReportedUpdateTime: Date  // 上报状态最后更新时间
  deltaCount: number            // 差异属性数量
}
```

**查询参数**：
```typescript
interface DeviceShadowPageReqVO {
  pageNo: number
  pageSize: number
  deviceName?: string           // 设备名称（模糊搜索）
  productId?: number            // 产品ID
  enabled?: boolean             // 是否启用
  syncStatus?: number           // 同步状态
  onlineStatus?: number         // 设备在线状态
}
```

#### 1.4.2 设备影子详情页 (detail/index.vue)

**Tab标签页设计**：
1. **状态视图** - 展示期望状态、上报状态、差异对比
2. **历史记录** - 展示影子状态变更历史
3. **配置管理** - 影子配置参数设置

**通用Header信息**：
- 设备基本信息：名称、产品、在线状态
- 影子同步状态
- 最后同步时间
- 操作按钮：刷新、清除影子、导出JSON

#### 1.4.3 状态视图组件 (ShadowStateView.vue)

**布局设计**（三栏对比）：
```
┌────────────────┬────────────────┬────────────────┐
│  期望状态       │   上报状态      │   状态差异      │
│  (Desired)     │  (Reported)    │   (Delta)      │
├────────────────┼────────────────┼────────────────┤
│  JSON展示      │   JSON展示     │   差异高亮     │
│  可编辑        │   只读         │   只读         │
│                │                │                │
│  ┌──────────┐ │   ┌──────────┐│   ┌──────────┐│
│  │ 编辑按钮  │ │   │ 刷新按钮  ││   │同步到设备││
│  └──────────┘ │   └──────────┘│   └──────────┘│
└────────────────┴────────────────┴────────────────┘
```

**功能点**：
1. **期望状态 (Desired)**
   - JSON编辑器展示
   - 支持编辑修改
   - 修改后自动更新版本号
   - 支持保存并推送到设备

2. **上报状态 (Reported)**
   - JSON只读展示
   - 实时刷新（设备在线时）
   - 显示最后更新时间

3. **状态差异 (Delta)**
   - 高亮显示期望状态与上报状态的差异
   - 差异字段列表展示
   - 一键同步到设备功能

**数据结构**：
```typescript
interface DeviceShadowDetailVO {
  deviceId: number
  desired: Record<string, any>      // 期望状态JSON对象
  reported: Record<string, any>     // 上报状态JSON对象
  delta: Record<string, any>        // 差异JSON对象
  metadata: {
    desired: Record<string, MetadataItem>
    reported: Record<string, MetadataItem>
  }
  version: number                   // 影子整体版本号
  timestamp: number                 // 时间戳
}

interface MetadataItem {
  timestamp: number                 // 属性最后更新时间戳
}
```

#### 1.4.4 历史记录视图 (ShadowHistoryView.vue)

**功能点**：
1. **变更记录列表**
   - 时间轴展示
   - 显示变更时间、操作类型、变更内容
   - 支持按时间范围筛选

2. **变更详情**
   - 变更前后对比
   - 变更来源：设备上报、应用下发
   - 操作人信息（应用下发时）

3. **数据导出**
   - 导出历史记录为Excel
   - 导出为JSON格式

**数据字段**：
```typescript
interface DeviceShadowHistoryVO {
  id: number
  deviceId: number
  operationType: number     // 操作类型: 1-更新期望状态, 2-设备上报状态, 3-清除影子
  changeType: number        // 变更类型: 1-期望状态, 2-上报状态
  beforeData: string        // 变更前数据（JSON字符串）
  afterData: string         // 变更后数据（JSON字符串）
  changeFields: string[]    // 变更字段列表
  version: number           // 版本号
  operatorId: number        // 操作人ID（应用操作时）
  operatorName: string      // 操作人名称
  createTime: Date          // 创建时间
}
```

#### 1.4.5 配置管理视图 (ShadowConfigView.vue)

**配置项**：
1. **基础配置**
   - 启用/禁用设备影子
   - 影子数据过期时间（秒）
   - 是否自动同步到设备

2. **高级配置**
   - 最大版本历史保留数量
   - 属性同步黑名单（不纳入影子管理的属性）
   - 同步策略：
     - 立即同步：状态改变立即推送
     - 定时同步：按固定间隔推送
     - 手动同步：仅手动触发

3. **通知配置**
   - 影子同步失败通知
   - 差异超过阈值通知

**数据结构**：
```typescript
interface DeviceShadowConfigVO {
  deviceId: number
  enabled: boolean              // 是否启用
  ttl: number                   // 数据过期时间（秒）0表示永不过期
  autoSync: boolean             // 是否自动同步
  maxHistoryCount: number       // 最大历史记录数
  propertyBlacklist: string[]   // 属性黑名单
  syncStrategy: number          // 同步策略: 1-立即, 2-定时, 3-手动
  syncInterval: number          // 定时同步间隔（秒）
  notifyOnSyncFail: boolean     // 同步失败时通知
  deltaThreshold: number        // 差异阈值（触发通知）
}
```

### 1.5 API接口设计

**前端API文件**: `hr-vue3/src/api/iot/shadow/index.ts`

```typescript
// 设备影子 API
export const DeviceShadowApi = {
  // 分页查询设备影子列表
  getShadowPage: async (params: DeviceShadowPageReqVO) => {
    return await request.get({ url: '/iot/shadow/page', params })
  },

  // 获取设备影子详情
  getShadowDetail: async (deviceId: number) => {
    return await request.get({ url: `/iot/shadow/detail?deviceId=${deviceId}` })
  },

  // 更新期望状态
  updateDesiredState: async (data: { deviceId: number; desired: Record<string, any> }) => {
    return await request.put({ url: '/iot/shadow/desired', data })
  },

  // 获取设备上报状态
  getReportedState: async (deviceId: number) => {
    return await request.get({ url: `/iot/shadow/reported?deviceId=${deviceId}` })
  },

  // 获取状态差异
  getDelta: async (deviceId: number) => {
    return await request.get({ url: `/iot/shadow/delta?deviceId=${deviceId}` })
  },

  // 清除设备影子
  clearShadow: async (deviceId: number) => {
    return await request.delete({ url: `/iot/shadow/clear?deviceId=${deviceId}` })
  },

  // 批量清除设备影子
  clearShadowBatch: async (deviceIds: number[]) => {
    return await request.delete({ url: '/iot/shadow/clear-batch', params: { deviceIds: deviceIds.join(',') } })
  },

  // 强制同步到设备
  syncToDevice: async (deviceId: number) => {
    return await request.post({ url: '/iot/shadow/sync', data: { deviceId } })
  },

  // 获取影子历史记录
  getShadowHistory: async (params: any) => {
    return await request.get({ url: '/iot/shadow/history/page', params })
  },

  // 获取影子配置
  getShadowConfig: async (deviceId: number) => {
    return await request.get({ url: `/iot/shadow/config?deviceId=${deviceId}` })
  },

  // 更新影子配置
  updateShadowConfig: async (data: DeviceShadowConfigVO) => {
    return await request.put({ url: '/iot/shadow/config', data })
  },

  // 启用/禁用设备影子
  toggleShadowEnabled: async (deviceId: number, enabled: boolean) => {
    return await request.put({ url: '/iot/shadow/toggle', data: { deviceId, enabled } })
  },

  // 导出影子数据
  exportShadow: async (deviceId: number) => {
    return await request.download({ url: `/iot/shadow/export?deviceId=${deviceId}` })
  }
}
```

---

## 二、边缘计算（Edge Computing）管理界面

### 2.1 功能概述

边缘计算模块允许在靠近数据源的边缘节点（边缘网关）上进行数据处理、分析和计算，减少数据传输延迟，降低云端计算压力，提高系统实时性。

### 2.2 核心概念

**边缘计算包含以下核心部分**：
- **边缘节点（Edge Node）**：执行计算任务的边缘设备（通常是网关设备）
- **边缘任务（Edge Task）**：在边缘节点上运行的计算任务
- **边缘函数（Edge Function）**：具体的计算逻辑（JavaScript、Python脚本等）
- **边缘数据流（Edge Data Flow）**：数据在边缘节点的处理流程

### 2.3 页面结构

```
hr-vue3/src/views/iot/edge/
├── node/                        # 边缘节点管理
│   ├── index.vue               # 节点列表页
│   ├── NodeForm.vue            # 节点表单
│   └── detail/                 # 节点详情
│       ├── index.vue           # 详情主页
│       ├── NodeInfo.vue        # 节点信息
│       ├── NodeMonitor.vue     # 节点监控
│       └── NodeTasks.vue       # 节点任务列表
├── function/                    # 边缘函数管理
│   ├── index.vue               # 函数列表页
│   ├── FunctionForm.vue        # 函数表单
│   └── FunctionEditor.vue      # 函数代码编辑器
├── task/                        # 边缘任务管理
│   ├── index.vue               # 任务列表页
│   ├── TaskForm.vue            # 任务表单
│   └── detail/                 # 任务详情
│       ├── index.vue           # 详情主页
│       ├── TaskInfo.vue        # 任务信息
│       ├── TaskLog.vue         # 任务日志
│       └── TaskMonitor.vue     # 任务监控
└── components/
    ├── CodeEditor.vue          # 代码编辑器组件
    ├── NodeSelector.vue        # 节点选择器
    ├── FunctionSelector.vue    # 函数选择器
    └── TaskStatusBadge.vue     # 任务状态标识
```

### 2.4 功能需求详细设计

#### 2.4.1 边缘节点管理 (node/index.vue)

**功能点**：
1. **节点列表展示**
   - 显示所有边缘节点（网关设备）
   - 支持按节点名称、状态、区域筛选
   - 显示节点信息：名称、IP、状态、资源使用率、任务数

2. **节点状态监控**
   - 在线/离线状态
   - CPU使用率
   - 内存使用率
   - 磁盘使用率
   - 运行任务数

3. **节点操作**
   - 注册边缘节点
   - 编辑节点信息
   - 启用/禁用节点
   - 删除节点
   - 查看节点详情
   - 远程重启节点

**数据字段**：
```typescript
interface EdgeNodeVO {
  id: number                    // 节点ID
  nodeName: string              // 节点名称
  nodeKey: string               // 节点标识（唯一）
  deviceId: number              // 关联的网关设备ID
  deviceName: string            // 设备名称
  nodeType: number              // 节点类型: 1-标准网关, 2-边缘服务器, 3-工控机
  status: number                // 节点状态: 0-离线, 1-在线, 2-故障
  ipAddress: string             // IP地址
  port: number                  // 端口
  region: string                // 所在区域
  cpuUsage: number              // CPU使用率 (0-100)
  memoryUsage: number           // 内存使用率 (0-100)
  diskUsage: number             // 磁盘使用率 (0-100)
  taskCount: number             // 运行任务数
  version: string               // 边缘计算引擎版本
  lastHeartbeatTime: Date       // 最后心跳时间
  createTime: Date              // 创建时间
  enabled: boolean              // 是否启用
}
```

**查询参数**：
```typescript
interface EdgeNodePageReqVO {
  pageNo: number
  pageSize: number
  nodeName?: string             // 节点名称（模糊搜索）
  status?: number               // 节点状态
  region?: string               // 区域
  enabled?: boolean             // 是否启用
}
```

#### 2.4.2 节点详情页 (node/detail/index.vue)

**Tab标签页设计**：
1. **节点信息** - 基本信息、配置参数
2. **实时监控** - CPU、内存、网络等实时监控图表
3. **运行任务** - 节点上运行的所有任务列表

**节点信息 (NodeInfo.vue)**：
- 基本信息：名称、类型、IP、版本、区域
- 配置信息：最大任务数、资源限制、日志级别
- 统计信息：总任务数、成功/失败任务数、运行时长

**节点监控 (NodeMonitor.vue)**：
- 实时资源监控图表（ECharts）
  - CPU使用率趋势
  - 内存使用率趋势
  - 网络流量趋势
  - 磁盘IO趋势
- 告警信息：资源超限告警

**节点任务列表 (NodeTasks.vue)**：
- 任务列表展示
- 任务状态统计
- 快捷操作：启动/停止任务

#### 2.4.3 边缘函数管理 (function/index.vue)

**功能点**：
1. **函数列表展示**
   - 显示所有边缘函数
   - 支持按函数名称、类型、状态筛选
   - 显示函数信息：名称、类型、版本、引用任务数

2. **函数操作**
   - 创建函数
   - 编辑函数代码
   - 删除函数
   - 发布/下线函数
   - 版本管理
   - 测试运行

3. **函数分类**
   - 数据转换函数
   - 数据过滤函数
   - 数据聚合函数
   - 告警判断函数
   - 自定义函数

**数据字段**：
```typescript
interface EdgeFunctionVO {
  id: number                    // 函数ID
  functionName: string          // 函数名称
  functionKey: string           // 函数标识（唯一）
  description: string           // 函数描述
  functionType: number          // 函数类型: 1-数据转换, 2-数据过滤, 3-聚合, 4-告警, 5-自定义
  language: number              // 语言: 1-JavaScript, 2-Python, 3-Lua
  code: string                  // 函数代码
  version: string               // 版本号
  status: number                // 状态: 0-草稿, 1-已发布, 2-已下线
  inputSchema: string           // 输入参数schema（JSON）
  outputSchema: string          // 输出参数schema（JSON）
  taskCount: number             // 被引用的任务数
  createTime: Date              // 创建时间
  publishTime: Date             // 发布时间
}
```

#### 2.4.4 函数编辑器 (function/FunctionEditor.vue)

**功能设计**：
1. **代码编辑区**
   - Monaco Editor代码编辑器
   - 语法高亮
   - 代码自动完成
   - 错误提示

2. **测试运行区**
   - 输入测试数据
   - 执行函数
   - 查看输出结果
   - 查看执行日志

3. **版本管理**
   - 版本历史列表
   - 版本对比
   - 回滚到历史版本

**代码模板示例**（JavaScript）：
```javascript
/**
 * 边缘函数入口
 * @param {Object} input - 输入数据
 * @param {Object} context - 上下文对象（设备信息、时间等）
 * @returns {Object} - 输出数据
 */
function main(input, context) {
  // 获取设备上报的温度
  const temperature = input.temperature;

  // 数据转换：摄氏度转华氏度
  const fahrenheit = (temperature * 9/5) + 32;

  // 返回处理结果
  return {
    temperature_c: temperature,
    temperature_f: fahrenheit,
    timestamp: context.timestamp,
    deviceId: context.deviceId
  };
}
```

#### 2.4.5 边缘任务管理 (task/index.vue)

**功能点**：
1. **任务列表展示**
   - 显示所有边缘任务
   - 支持按任务名称、节点、状态筛选
   - 显示任务信息：名称、节点、函数、状态、执行次数

2. **任务控制**
   - 创建任务
   - 编辑任务
   - 启动/停止任务
   - 删除任务
   - 查看任务详情

3. **任务调度**
   - 触发方式：实时触发、定时触发、手动触发
   - 调度策略配置

**数据字段**：
```typescript
interface EdgeTaskVO {
  id: number                    // 任务ID
  taskName: string              // 任务名称
  taskKey: string               // 任务标识（唯一）
  description: string           // 任务描述
  nodeId: number                // 边缘节点ID
  nodeName: string              // 节点名称
  functionId: number            // 边缘函数ID
  functionName: string          // 函数名称
  triggerType: number           // 触发类型: 1-实时(设备数据), 2-定时, 3-手动
  triggerConfig: string         // 触发配置（JSON）
  inputSource: number           // 输入源: 1-设备数据, 2-其他任务输出, 3-HTTP请求
  inputConfig: string           // 输入配置（JSON）
  outputTarget: number          // 输出目标: 1-云端, 2-本地存储, 3-其他任务, 4-设备控制
  outputConfig: string          // 输出配置（JSON）
  status: number                // 任务状态: 0-已停止, 1-运行中, 2-暂停, 3-错误
  executionCount: number        // 执行次数
  successCount: number          // 成功次数
  failCount: number             // 失败次数
  lastExecutionTime: Date       // 最后执行时间
  lastExecutionResult: string   // 最后执行结果
  createTime: Date              // 创建时间
  enabled: boolean              // 是否启用
}
```

**查询参数**：
```typescript
interface EdgeTaskPageReqVO {
  pageNo: number
  pageSize: number
  taskName?: string             // 任务名称（模糊搜索）
  nodeId?: number               // 节点ID
  functionId?: number           // 函数ID
  status?: number               // 任务状态
  triggerType?: number          // 触发类型
}
```

#### 2.4.6 任务详情页 (task/detail/index.vue)

**Tab标签页设计**：
1. **任务信息** - 基本信息、配置参数
2. **执行日志** - 任务执行日志
3. **性能监控** - 执行性能监控

**任务信息 (TaskInfo.vue)**：
- 基本信息：任务名称、节点、函数、状态
- 触发配置：触发类型、触发条件
- 输入配置：数据源、过滤条件
- 输出配置：输出目标、输出格式
- 统计信息：执行次数、成功率、平均耗时

**任务日志 (TaskLog.vue)**：
- 日志列表展示
- 支持按时间范围、日志级别筛选
- 显示：执行时间、输入数据、输出数据、执行耗时、状态
- 日志详情查看

**数据字段**：
```typescript
interface EdgeTaskLogVO {
  id: number                    // 日志ID
  taskId: number                // 任务ID
  nodeId: number                // 节点ID
  executionId: string           // 执行ID（唯一标识一次执行）
  inputData: string             // 输入数据（JSON）
  outputData: string            // 输出数据（JSON）
  status: number                // 执行状态: 1-成功, 2-失败
  errorMessage: string          // 错误信息
  executionTime: number         // 执行耗时（毫秒）
  startTime: Date               // 开始时间
  endTime: Date                 // 结束时间
  logLevel: number              // 日志级别: 1-DEBUG, 2-INFO, 3-WARN, 4-ERROR
  message: string               // 日志消息
}
```

**任务监控 (TaskMonitor.vue)**：
- 执行次数趋势图
- 成功率统计图
- 平均耗时趋势图
- 错误统计图

### 2.5 API接口设计

**前端API文件**: `hr-vue3/src/api/iot/edge/`

```typescript
// ===== node/index.ts - 边缘节点API =====
export const EdgeNodeApi = {
  // 分页查询边缘节点
  getNodePage: async (params: EdgeNodePageReqVO) => {
    return await request.get({ url: '/iot/edge/node/page', params })
  },

  // 获取节点详情
  getNode: async (id: number) => {
    return await request.get({ url: `/iot/edge/node/get?id=${id}` })
  },

  // 创建节点
  createNode: async (data: EdgeNodeVO) => {
    return await request.post({ url: '/iot/edge/node/create', data })
  },

  // 更新节点
  updateNode: async (data: EdgeNodeVO) => {
    return await request.put({ url: '/iot/edge/node/update', data })
  },

  // 删除节点
  deleteNode: async (id: number) => {
    return await request.delete({ url: `/iot/edge/node/delete?id=${id}` })
  },

  // 启用/禁用节点
  toggleNodeEnabled: async (id: number, enabled: boolean) => {
    return await request.put({ url: '/iot/edge/node/toggle', data: { id, enabled } })
  },

  // 远程重启节点
  restartNode: async (id: number) => {
    return await request.post({ url: '/iot/edge/node/restart', data: { id } })
  },

  // 获取节点监控数据
  getNodeMonitor: async (id: number, startTime: Date, endTime: Date) => {
    return await request.get({ url: '/iot/edge/node/monitor', params: { id, startTime, endTime } })
  },

  // 获取节点精简列表
  getSimpleNodeList: async () => {
    return await request.get({ url: '/iot/edge/node/simple-list' })
  }
}

// ===== function/index.ts - 边缘函数API =====
export const EdgeFunctionApi = {
  // 分页查询边缘函数
  getFunctionPage: async (params: any) => {
    return await request.get({ url: '/iot/edge/function/page', params })
  },

  // 获取函数详情
  getFunction: async (id: number) => {
    return await request.get({ url: `/iot/edge/function/get?id=${id}` })
  },

  // 创建函数
  createFunction: async (data: EdgeFunctionVO) => {
    return await request.post({ url: '/iot/edge/function/create', data })
  },

  // 更新函数
  updateFunction: async (data: EdgeFunctionVO) => {
    return await request.put({ url: '/iot/edge/function/update', data })
  },

  // 删除函数
  deleteFunction: async (id: number) => {
    return await request.delete({ url: `/iot/edge/function/delete?id=${id}` })
  },

  // 发布函数
  publishFunction: async (id: number) => {
    return await request.put({ url: '/iot/edge/function/publish', data: { id } })
  },

  // 下线函数
  offlineFunction: async (id: number) => {
    return await request.put({ url: '/iot/edge/function/offline', data: { id } })
  },

  // 测试运行函数
  testFunction: async (data: { id: number; inputData: any }) => {
    return await request.post({ url: '/iot/edge/function/test', data })
  },

  // 获取函数版本历史
  getFunctionVersions: async (functionId: number) => {
    return await request.get({ url: '/iot/edge/function/versions', params: { functionId } })
  },

  // 获取函数精简列表
  getSimpleFunctionList: async () => {
    return await request.get({ url: '/iot/edge/function/simple-list' })
  }
}

// ===== task/index.ts - 边缘任务API =====
export const EdgeTaskApi = {
  // 分页查询边缘任务
  getTaskPage: async (params: EdgeTaskPageReqVO) => {
    return await request.get({ url: '/iot/edge/task/page', params })
  },

  // 获取任务详情
  getTask: async (id: number) => {
    return await request.get({ url: `/iot/edge/task/get?id=${id}` })
  },

  // 创建任务
  createTask: async (data: EdgeTaskVO) => {
    return await request.post({ url: '/iot/edge/task/create', data })
  },

  // 更新任务
  updateTask: async (data: EdgeTaskVO) => {
    return await request.put({ url: '/iot/edge/task/update', data })
  },

  // 删除任务
  deleteTask: async (id: number) => {
    return await request.delete({ url: `/iot/edge/task/delete?id=${id}` })
  },

  // 启动任务
  startTask: async (id: number) => {
    return await request.post({ url: '/iot/edge/task/start', data: { id } })
  },

  // 停止任务
  stopTask: async (id: number) => {
    return await request.post({ url: '/iot/edge/task/stop', data: { id } })
  },

  // 手动触发任务
  triggerTask: async (id: number, inputData?: any) => {
    return await request.post({ url: '/iot/edge/task/trigger', data: { id, inputData } })
  },

  // 获取任务执行日志
  getTaskLogs: async (params: any) => {
    return await request.get({ url: '/iot/edge/task/log/page', params })
  },

  // 获取任务监控数据
  getTaskMonitor: async (id: number, startTime: Date, endTime: Date) => {
    return await request.get({ url: '/iot/edge/task/monitor', params: { id, startTime, endTime } })
  }
}
```

---

## 三、路由配置

### 3.1 设备影子路由

**文件路径**: `hr-vue3/src/router/index.ts` 或相应的路由模块文件

```typescript
{
  path: '/iot',
  name: 'IoT',
  component: Layout,
  redirect: '/iot/home',
  meta: { title: 'IoT管理', icon: 'ep:connection' },
  children: [
    // ... 其他IoT路由
    {
      path: 'shadow',
      name: 'DeviceShadow',
      meta: { title: '设备影子', icon: 'ep:copy-document' },
      children: [
        {
          path: 'list',
          name: 'DeviceShadowList',
          component: () => import('@/views/iot/shadow/index.vue'),
          meta: { title: '设备影子列表', activeMenu: '/iot/shadow' }
        },
        {
          path: 'detail/:deviceId',
          name: 'DeviceShadowDetail',
          component: () => import('@/views/iot/shadow/detail/index.vue'),
          meta: {
            title: '设备影子详情',
            activeMenu: '/iot/shadow',
            noCache: true,
            hidden: true
          }
        }
      ]
    }
  ]
}
```

### 3.2 边缘计算路由

```typescript
{
  path: '/iot',
  name: 'IoT',
  component: Layout,
  redirect: '/iot/home',
  meta: { title: 'IoT管理', icon: 'ep:connection' },
  children: [
    // ... 其他IoT路由
    {
      path: 'edge',
      name: 'EdgeComputing',
      meta: { title: '边缘计算', icon: 'ep:cpu' },
      children: [
        {
          path: 'node',
          name: 'EdgeNode',
          component: () => import('@/views/iot/edge/node/index.vue'),
          meta: { title: '边缘节点' }
        },
        {
          path: 'node/detail/:id',
          name: 'EdgeNodeDetail',
          component: () => import('@/views/iot/edge/node/detail/index.vue'),
          meta: {
            title: '节点详情',
            activeMenu: '/iot/edge/node',
            noCache: true,
            hidden: true
          }
        },
        {
          path: 'function',
          name: 'EdgeFunction',
          component: () => import('@/views/iot/edge/function/index.vue'),
          meta: { title: '边缘函数' }
        },
        {
          path: 'task',
          name: 'EdgeTask',
          component: () => import('@/views/iot/edge/task/index.vue'),
          meta: { title: '边缘任务' }
        },
        {
          path: 'task/detail/:id',
          name: 'EdgeTaskDetail',
          component: () => import('@/views/iot/edge/task/detail/index.vue'),
          meta: {
            title: '任务详情',
            activeMenu: '/iot/edge/task',
            noCache: true,
            hidden: true
          }
        }
      ]
    }
  ]
}
```

---

## 四、UI/UX设计要点

### 4.1 设计原则

1. **一致性**：遵循现有IoT模块的设计风格
2. **简洁性**：界面清晰，操作直观
3. **响应性**：实时数据更新，操作及时反馈
4. **可视化**：使用图表展示监控数据和统计信息

### 4.2 组件库

- **Element Plus**：主要UI组件库
- **ECharts**：数据可视化图表
- **Monaco Editor**：代码编辑器（边缘函数）
- **JSON Editor**：JSON数据编辑（设备影子）

### 4.3 颜色规范

遵循Element Plus主题色：
- **主色调**: #409EFF (蓝色)
- **成功**: #67C23A (绿色)
- **警告**: #E6A23C (橙色)
- **危险**: #F56C6C (红色)
- **信息**: #909399 (灰色)

### 4.4 图标使用

- **设备影子**: `ep:copy-document`、`ep:document-copy`
- **边缘计算**: `ep:cpu`、`ep:box`
- **边缘节点**: `ep:monitor`、`ep:connection`
- **边缘函数**: `ep:code`、`ep:document`
- **边缘任务**: `ep:operation`、`ep:circle-check`

---

## 五、技术实现要点

### 5.1 实时数据更新

**WebSocket连接**：
- 设备影子状态变更实时推送
- 边缘节点状态实时监控
- 任务执行日志实时推送

**轮询机制**：
- 监控数据定时刷新（5-10秒间隔）
- 设备在线状态定时更新

### 5.2 数据缓存策略

**前端缓存**：
- 产品/设备列表缓存（Pinia store）
- 边缘节点列表缓存
- 边缘函数列表缓存

**缓存失效**：
- 数据变更后自动刷新缓存
- 用户手动刷新

### 5.3 性能优化

1. **列表虚拟滚动**：大数据量列表使用虚拟滚动
2. **懒加载**：图表和详情页按需加载
3. **防抖节流**：搜索输入、数据刷新使用防抖节流
4. **分页加载**：所有列表支持分页

### 5.4 错误处理

1. **接口错误**：统一错误提示，记录错误日志
2. **数据校验**：表单提交前校验
3. **超时处理**：长时间操作显示加载状态
4. **降级方案**：WebSocket连接失败时降级为轮询

---

## 六、开发优先级

### 第一阶段（核心功能）

**设备影子**：
1. 设备影子列表页
2. 设备影子详情页 - 状态视图
3. 期望状态更新功能
4. 基础API接口

**边缘计算**：
1. 边缘节点管理（列表、详情）
2. 边缘函数管理（列表、编辑）
3. 边缘任务管理（列表、启停）
4. 基础API接口

### 第二阶段（增强功能）

**设备影子**：
1. 历史记录视图
2. 配置管理视图
3. 批量操作功能
4. 数据导出功能

**边缘计算**：
1. 节点监控视图
2. 函数版本管理
3. 任务日志查询
4. 任务性能监控

### 第三阶段（高级功能）

**设备影子**：
1. 实时数据推送
2. 差异自动同步
3. 影子数据分析

**边缘计算**：
1. 可视化任务编排
2. 函数市场（预置函数模板）
3. 多节点任务协同

---

## 七、测试计划

### 7.1 单元测试

- API接口测试
- 组件逻辑测试
- 工具函数测试

### 7.2 集成测试

- 页面流程测试
- 数据交互测试
- 权限控制测试

### 7.3 E2E测试

- 关键业务流程端到端测试
- 跨页面操作测试

### 7.4 性能测试

- 大数据量列表渲染
- 实时数据推送压力测试
- 并发操作测试

---

## 八、后端接口需求（参考）

> 注：前端开发依赖后端接口，以下为后端需要提供的接口清单（仅供参考）

### 8.1 设备影子接口

**Controller路径**: `IotDeviceShadowController`

```java
// 分页查询
GET /iot/shadow/page

// 获取详情
GET /iot/shadow/detail?deviceId={deviceId}

// 更新期望状态
PUT /iot/shadow/desired

// 获取上报状态
GET /iot/shadow/reported?deviceId={deviceId}

// 获取状态差异
GET /iot/shadow/delta?deviceId={deviceId}

// 清除影子
DELETE /iot/shadow/clear?deviceId={deviceId}

// 批量清除
DELETE /iot/shadow/clear-batch?deviceIds={deviceIds}

// 同步到设备
POST /iot/shadow/sync

// 历史记录
GET /iot/shadow/history/page

// 配置管理
GET /iot/shadow/config?deviceId={deviceId}
PUT /iot/shadow/config

// 启用/禁用
PUT /iot/shadow/toggle

// 导出
GET /iot/shadow/export?deviceId={deviceId}
```

### 8.2 边缘计算接口

**Controller路径**: `IotEdgeNodeController`, `IotEdgeFunctionController`, `IotEdgeTaskController`

```java
// ===== 边缘节点 =====
GET /iot/edge/node/page
GET /iot/edge/node/get?id={id}
POST /iot/edge/node/create
PUT /iot/edge/node/update
DELETE /iot/edge/node/delete?id={id}
PUT /iot/edge/node/toggle
POST /iot/edge/node/restart
GET /iot/edge/node/monitor
GET /iot/edge/node/simple-list

// ===== 边缘函数 =====
GET /iot/edge/function/page
GET /iot/edge/function/get?id={id}
POST /iot/edge/function/create
PUT /iot/edge/function/update
DELETE /iot/edge/function/delete?id={id}
PUT /iot/edge/function/publish
PUT /iot/edge/function/offline
POST /iot/edge/function/test
GET /iot/edge/function/versions
GET /iot/edge/function/simple-list

// ===== 边缘任务 =====
GET /iot/edge/task/page
GET /iot/edge/task/get?id={id}
POST /iot/edge/task/create
PUT /iot/edge/task/update
DELETE /iot/edge/task/delete?id={id}
POST /iot/edge/task/start
POST /iot/edge/task/stop
POST /iot/edge/task/trigger
GET /iot/edge/task/log/page
GET /iot/edge/task/monitor
```

---

## 九、数据字典（前端枚举）

### 9.1 设备影子相关枚举

```typescript
// 影子同步状态
export enum ShadowSyncStatus {
  SYNCED = 0,        // 已同步
  NOT_SYNCED = 1,    // 未同步
  PARTIAL_SYNCED = 2 // 部分同步
}

// 影子操作类型
export enum ShadowOperationType {
  UPDATE_DESIRED = 1,   // 更新期望状态
  UPDATE_REPORTED = 2,  // 设备上报状态
  CLEAR_SHADOW = 3      // 清除影子
}

// 影子同步策略
export enum ShadowSyncStrategy {
  IMMEDIATE = 1,  // 立即同步
  SCHEDULED = 2,  // 定时同步
  MANUAL = 3      // 手动同步
}
```

### 9.2 边缘计算相关枚举

```typescript
// 边缘节点类型
export enum EdgeNodeType {
  STANDARD_GATEWAY = 1, // 标准网关
  EDGE_SERVER = 2,      // 边缘服务器
  INDUSTRIAL_PC = 3     // 工控机
}

// 边缘节点状态
export enum EdgeNodeStatus {
  OFFLINE = 0,  // 离线
  ONLINE = 1,   // 在线
  FAULT = 2     // 故障
}

// 边缘函数类型
export enum EdgeFunctionType {
  DATA_TRANSFORM = 1,  // 数据转换
  DATA_FILTER = 2,     // 数据过滤
  DATA_AGGREGATE = 3,  // 数据聚合
  ALERT = 4,           // 告警判断
  CUSTOM = 5           // 自定义
}

// 边缘函数语言
export enum EdgeFunctionLanguage {
  JAVASCRIPT = 1,  // JavaScript
  PYTHON = 2,      // Python
  LUA = 3          // Lua
}

// 边缘函数状态
export enum EdgeFunctionStatus {
  DRAFT = 0,      // 草稿
  PUBLISHED = 1,  // 已发布
  OFFLINE = 2     // 已下线
}

// 边缘任务触发类型
export enum EdgeTaskTriggerType {
  REALTIME = 1,  // 实时触发（设备数据）
  SCHEDULED = 2, // 定时触发
  MANUAL = 3     // 手动触发
}

// 边缘任务状态
export enum EdgeTaskStatus {
  STOPPED = 0,  // 已停止
  RUNNING = 1,  // 运行中
  PAUSED = 2,   // 暂停
  ERROR = 3     // 错误
}

// 边缘任务输入源
export enum EdgeTaskInputSource {
  DEVICE_DATA = 1,     // 设备数据
  TASK_OUTPUT = 2,     // 其他任务输出
  HTTP_REQUEST = 3     // HTTP请求
}

// 边缘任务输出目标
export enum EdgeTaskOutputTarget {
  CLOUD = 1,           // 云端
  LOCAL_STORAGE = 2,   // 本地存储
  OTHER_TASK = 3,      // 其他任务
  DEVICE_CONTROL = 4   // 设备控制
}
```

---

## 十、FAQ（常见问题）

### Q1: 设备影子与设备属性有什么区别？
**A**: 设备属性是设备物模型的一部分,表示设备的实时状态。设备影子是设备属性的缓存副本,主要用于解决设备离线时的状态同步问题。应用程序可以随时读写设备影子,而不需要设备在线。

### Q2: 边缘计算与规则引擎有什么区别？
**A**: 规则引擎主要在云端执行,处理设备上报到云端的数据。边缘计算在边缘节点（网关）上执行,可以在数据上报到云端之前进行预处理,降低延迟和云端压力。两者可以配合使用。

### Q3: 边缘函数支持哪些语言？
**A**: 第一期主要支持JavaScript,后续计划支持Python和Lua。JavaScript具有较好的跨平台性和丰富的生态。

### Q4: 设备影子的数据会永久保存吗？
**A**: 可以配置设备影子的TTL（过期时间）。如果设置为0,表示永不过期。建议根据业务需求合理设置过期时间,避免占用过多存储空间。

### Q5: 边缘节点资源有限,如何避免任务过载？
**A**: 可以在边缘节点配置中设置最大任务数和资源限制。系统会监控节点资源使用率,当超过阈值时会发出告警,管理员可以及时调整任务分配。

---

## 十一、总结

本需求规划文档详细定义了设备影子和边缘计算两个模块的前端功能需求、页面结构、数据模型、API接口和技术实现要点。

**开发建议**：
1. 先完成核心功能,确保基本流程可用
2. 逐步迭代,增加高级功能
3. 注重代码复用,抽取公共组件
4. 遵循现有代码规范和设计模式
5. 做好错误处理和用户体验优化

**预期效果**：
- 提供直观易用的设备影子管理界面
- 提供强大灵活的边缘计算配置能力
- 降低系统延迟,提高实时性
- 减轻云端计算和存储压力

---

**文档版本**: v1.0
**最后更新**: 2025-11-18
