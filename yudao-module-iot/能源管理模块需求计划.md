# 能源管理模块需求计划

## 一、项目概述

### 1.1 项目背景
在现有的IoT物联网平台基础上，新增能源管理模块，实现对建筑物能源消耗的全方位监控、分析和管理，帮助企业降低能源成本，提升能源使用效率。

### 1.2 项目目标
- 实现多层级空间结构管理（建筑→区域→楼层→房间→设备）
- 实现多种能源类型的数据采集和存储（电、水、气、热等）
- 提供丰富的数据统计分析功能
- 提供可视化的能耗监控大屏
- 生成各类能耗报表
- 实现能耗异常告警

### 1.3 技术架构
- 后端：Spring Boot 2.7 + MyBatis Plus
- 数据库：MySQL（业务数据） + TDengine（时序数据）
- 消息队列：RocketMQ
- 缓存：Redis
- 前端：Vue3 + Element-Plus + ECharts

---

## 二、功能模块设计

### 2.1 空间层级管理模块

#### 2.1.1 建筑管理
**功能描述**：管理企业的所有建筑物信息

**数据字段**：
- 建筑ID
- 建筑名称
- 建筑编码
- 建筑地址
- 建筑面积（平方米）
- 建筑类型（办公楼、厂房、宿舍等）
- 建筑图片
- 经纬度坐标
- 建筑描述
- 创建时间
- 状态（启用/停用）

**功能点**：
- [ ] 建筑列表查询（分页、搜索、筛选）
- [ ] 新增建筑
- [ ] 编辑建筑
- [ ] 删除建筑
- [ ] 建筑详情查看
- [ ] 建筑树形结构展示

#### 2.1.2 区域管理
**功能描述**：管理建筑内的区域划分

**数据字段**：
- 区域ID
- 区域名称
- 区域编码
- 所属建筑
- 区域面积
- 区域类型（生产区、办公区、公共区等）
- 区域描述
- 排序
- 状态

**功能点**：
- [ ] 区域列表查询
- [ ] 按建筑查询区域
- [ ] 新增区域
- [ ] 编辑区域
- [ ] 删除区域
- [ ] 区域排序

#### 2.1.3 楼层管理
**功能描述**：管理建筑的楼层信息

**数据字段**：
- 楼层ID
- 楼层名称
- 楼层编码
- 所属建筑
- 所属区域
- 楼层序号（-2, -1, 1, 2...）
- 楼层面积
- 楼层平面图
- 楼层描述
- 状态

**功能点**：
- [ ] 楼层列表查询
- [ ] 按建筑/区域查询楼层
- [ ] 新增楼层
- [ ] 编辑楼层
- [ ] 删除楼层
- [ ] 上传楼层平面图
- [ ] 楼层排序

#### 2.1.4 房间管理
**功能描述**：管理楼层的房间信息

**数据字段**：
- 房间ID
- 房间名称
- 房间编码
- 所属建筑
- 所属区域
- 所属楼层
- 房间面积
- 房间类型（会议室、办公室、机房、仓库等）
- 房间用途
- 房间位置（在平面图上的坐标）
- 房间描述
- 状态

**功能点**：
- [ ] 房间列表查询
- [ ] 按建筑/区域/楼层查询房间
- [ ] 新增房间
- [ ] 编辑房间
- [ ] 删除房间
- [ ] 房间在平面图上标注

#### 2.1.5 设备空间绑定
**功能描述**：将能源采集设备绑定到具体的空间位置

**数据字段**：
- 绑定ID
- 设备ID（关联iot_device表）
- 建筑ID
- 区域ID
- 楼层ID
- 房间ID
- 绑定时间
- 状态

**功能点**：
- [ ] 设备绑定到建筑/区域/楼层/房间
- [ ] 设备解绑
- [ ] 查询空间下的所有设备
- [ ] 查询设备所在空间位置
- [ ] 批量绑定设备

---

### 2.2 能源类型管理模块

#### 2.2.1 能源类型定义
**功能描述**：定义系统支持的能源类型

**能源类型**：
- 电能（kWh）- 总用电、照明用电、空调用电、动力用电、特殊用电
- 水能（m³）- 自来水、中水、热水
- 燃气（m³）- 天然气、液化气
- 热能（GJ）- 蒸汽、热水
- 冷能（GJ）- 冷冻水
- 其他能源（如压缩空气、氧气等）

**数据字段**：
- 能源类型ID
- 能源名称
- 能源编码
- 能源分类（主能源/子能源）
- 父级能源ID
- 计量单位
- 单位转换系数（转换为标准煤）
- 能源图标
- 能源颜色（用于图表展示）
- 排序
- 状态

**功能点**：
- [ ] 能源类型列表
- [ ] 新增能源类型
- [ ] 编辑能源类型
- [ ] 删除能源类型
- [ ] 能源类型树形结构

#### 2.2.2 计量点管理
**功能描述**：管理能源计量点（即具体的能源采集点）

**数据字段**：
- 计量点ID
- 计量点名称
- 计量点编码
- 能源类型ID
- 关联设备ID
- 关联设备属性（如设备的哪个数据点）
- 所属建筑
- 所属区域
- 所属楼层
- 所属房间
- 计量点类型（一级表、二级表、三级表）
- 父级计量点ID（用于分级计量）
- 计量倍率（CT/PT）
- 是否虚拟表（通过其他表计算得出）
- 计算公式（虚拟表时使用）
- 状态

**功能点**：
- [ ] 计量点列表查询
- [ ] 按能源类型/空间位置筛选计量点
- [ ] 新增计量点
- [ ] 编辑计量点
- [ ] 删除计量点
- [ ] 计量点绑定设备
- [ ] 虚拟表计算配置
- [ ] 计量点树形结构（展示分级关系）

---

### 2.3 能源数据采集和存储模块

#### 2.3.1 实时数据采集
**功能描述**：从各类能源计量设备采集实时数据

**数据来源**：
- Modbus协议设备（电能表、水表、气表等）
- MQTT协议设备
- HTTP接口设备
- TCP协议设备

**采集策略**：
- 实时采集（秒级/分钟级）
- 定时采集
- 变化采集（数据变化时采集）

**数据字段**：
- 记录ID
- 计量点ID
- 设备ID
- 能源类型
- 空间层级（建筑/区域/楼层/房间）
- 采集时间
- 原始数据（设备上报的原始值）
- 实际数据（经过倍率换算后的值）
- 瞬时功率/流量
- 累计值
- 数据质量（正常/异常）
- 数据来源

**功能点**：
- [ ] 设备数据自动采集
- [ ] 数据质量校验
- [ ] 异常数据标记
- [ ] 数据倍率换算
- [ ] 实时数据推送（WebSocket）

#### 2.3.2 历史数据存储
**功能描述**：将采集的能源数据存储到时序数据库

**存储策略**：
- 原始数据：TDengine超级表（高性能时序存储）
- 统计数据：MySQL（分钟/小时/天/月统计）

**数据聚合**：
- 分钟级聚合（最大值、最小值、平均值、累计值）
- 小时级聚合
- 天级聚合
- 月级聚合

**数据字段**：
- 时间戳
- 计量点ID
- 能源类型
- 建筑/区域/楼层/房间ID
- 最大值
- 最小值
- 平均值
- 起始值
- 结束值
- 差值（能耗量）
- 统计周期（分钟/小时/天/月）

**功能点**：
- [ ] 实时数据写入TDengine
- [ ] 定时任务进行数据聚合
- [ ] 历史数据查询接口
- [ ] 数据降采样（减少存储和查询压力）
- [ ] 数据归档策略（超过一定时间的数据归档）

---

### 2.4 能耗统计分析模块

#### 2.4.1 实时监控
**功能描述**：实时监控各层级的能源消耗情况

**监控维度**：
- 按建筑监控
- 按区域监控
- 按楼层监控
- 按房间监控
- 按设备监控

**监控指标**：
- 实时功率/流量
- 今日能耗
- 本月能耗
- 本年能耗
- 在线设备数
- 离线设备数

**功能点**：
- [ ] 实时数据大屏展示
- [ ] 各层级能耗总览
- [ ] 设备在线状态监控
- [ ] 实时告警提示
- [ ] 数据自动刷新

#### 2.4.2 历史数据查询
**功能描述**：查询历史能耗数据

**查询维度**：
- 时间维度：日、周、月、年、自定义时间段
- 空间维度：建筑、区域、楼层、房间
- 能源维度：按能源类型查询
- 设备维度：按计量点查询

**查询方式**：
- 能耗趋势查询（折线图）
- 能耗分布查询（饼图、柱状图）
- 能耗排名查询（排行榜）
- 能耗对比查询（同比、环比）

**功能点**：
- [ ] 多维度查询条件组合
- [ ] 时间段选择（日期选择器）
- [ ] 层级联动选择（建筑→区域→楼层→房间）
- [ ] 数据表格展示
- [ ] 数据图表展示
- [ ] 数据导出（Excel、PDF）

#### 2.4.3 分项能耗统计
**功能描述**：按能源类型进行分项统计

**统计项**：
- 电能分项（照明、空调、动力、特殊）
- 水能分项（自来水、中水、热水）
- 其他能源分项

**统计指标**：
- 各分项能耗值
- 各分项占比
- 各分项趋势
- 各分项排名

**功能点**：
- [ ] 分项能耗总览
- [ ] 分项能耗占比分析（饼图）
- [ ] 分项能耗趋势分析（折线图）
- [ ] 分项能耗对比（柱状图）

#### 2.4.4 同比环比分析
**功能描述**：进行同比和环比数据分析

**分析类型**：
- 同比分析（与去年同期对比）
  - 日同比
  - 周同比
  - 月同比
  - 年同比
- 环比分析（与上一周期对比）
  - 日环比
  - 周环比
  - 月环比

**分析指标**：
- 能耗值对比
- 增长率
- 增长量
- 趋势分析

**功能点**：
- [ ] 同比数据计算
- [ ] 环比数据计算
- [ ] 同比环比可视化展示
- [ ] 增长率分析
- [ ] 异常波动提示

#### 2.4.5 能耗排名
**功能描述**：对各空间或设备的能耗进行排名

**排名维度**：
- 建筑能耗排名
- 区域能耗排名
- 楼层能耗排名
- 房间能耗排名
- 设备能耗排名

**排名周期**：
- 日排名
- 周排名
- 月排名
- 年排名

**功能点**：
- [ ] 能耗排名TOP10/20
- [ ] 排名趋势分析
- [ ] 排名变化提示
- [ ] 排名图表展示（柱状图、排行榜）

#### 2.4.6 负荷分析
**功能描述**：分析能源负荷特性

**分析内容**：
- 负荷曲线（24小时、一周、一月）
- 峰值负荷分析
- 谷值负荷分析
- 平均负荷分析
- 负荷率分析

**功能点**：
- [ ] 负荷曲线展示
- [ ] 峰谷负荷统计
- [ ] 负荷率计算
- [ ] 负荷预测（可选）

---

### 2.5 可视化展示模块

#### 2.5.1 能耗监控大屏
**功能描述**：提供大屏展示能耗监控数据

**大屏布局**：
```
┌─────────────────────────────────────────────────────────┐
│  能源管理监控大屏                        2025-11-16 14:30 │
├──────────────┬──────────────┬──────────────┬─────────────┤
│  今日总能耗    │  本月总能耗    │  本年总能耗    │  在线设备    │
│  8,520 kWh   │ 256,800 kWh  │ 3,250,000 kWh│  128/130   │
├──────────────┴──────────────┴──────────────┴─────────────┤
│  实时能耗趋势图（折线图）                                   │
│  ～～～～～～～～～～～～～～～～～～～～～～～～～～～～～～   │
├────────────────────────────┬────────────────────────────┤
│  分项能耗占比（饼图）          │  各建筑能耗排名（柱状图）      │
│     ◐ 照明 30%             │  ████ 1号楼 5200kWh        │
│     ◑ 空调 40%             │  ███  2号楼 4800kWh        │
│     ◒ 动力 25%             │  ██   3号楼 3200kWh        │
│     ◓ 其他 5%              │  █    4号楼 1800kWh        │
├────────────────────────────┼────────────────────────────┤
│  区域能耗分布（地图）          │  告警信息列表                │
│  🗺️                        │  ⚠️ 3号楼2层能耗异常        │
│                            │  ⚠️ 水表W001通讯中断        │
└────────────────────────────┴────────────────────────────┘
```

**功能点**：
- [ ] 大屏自适应布局
- [ ] 数据实时刷新
- [ ] 炫酷的可视化效果
- [ ] 全屏展示
- [ ] 支持多种主题（深色/浅色）

#### 2.5.2 图表组件
**功能描述**：提供丰富的图表组件

**图表类型**：
- 折线图（能耗趋势、负荷曲线）
- 柱状图（能耗对比、排名）
- 饼图（能耗占比）
- 环形图（能耗分布）
- 仪表盘（实时功率）
- 雷达图（能效指标）
- 热力图（能耗密度）
- 桑基图（能源流向）
- 日历热力图（能耗日历）

**功能点**：
- [ ] 图表配置化
- [ ] 图表交互（放大、缩小、拖拽）
- [ ] 图表联动
- [ ] 图表导出（图片、PDF）
- [ ] 图表主题切换

#### 2.5.3 空间树形展示
**功能描述**：树形结构展示空间层级

**展示内容**：
```
📁 总公司
├─ 🏢 1号办公楼
│  ├─ 📦 A区
│  │  ├─ 🔼 1层
│  │  │  ├─ 🚪 101办公室
│  │  │  └─ 🚪 102会议室
│  │  └─ 🔼 2层
│  └─ 📦 B区
├─ 🏢 2号厂房
└─ 🏢 3号宿舍楼
```

**功能点**：
- [ ] 树形结构展示
- [ ] 节点展开/收起
- [ ] 节点搜索
- [ ] 节点点击查看能耗
- [ ] 节点能耗实时显示
- [ ] 拖拽排序（可选）

#### 2.5.4 地图展示
**功能描述**：在地图上展示建筑物和能耗信息

**地图类型**：
- 2D平面地图
- 建筑平面图
- 楼层平面图

**展示内容**：
- 建筑位置标注
- 建筑能耗热力图
- 设备位置标注
- 设备实时状态

**功能点**：
- [ ] 地图集成（百度地图/高德地图）
- [ ] 建筑物标注
- [ ] 热力图展示
- [ ] 平面图上传
- [ ] 设备在平面图上标注
- [ ] 点击设备查看详情

---

### 2.6 报表管理模块

#### 2.6.1 预定义报表
**功能描述**：提供常用的预定义报表

**报表类型**：
- 日能耗报表
- 周能耗报表
- 月能耗报表
- 年能耗报表
- 分项能耗报表
- 同比环比报表
- 能耗排名报表
- 设备运行报表

**报表内容**：
- 报表标题
- 统计周期
- 统计数据表格
- 图表展示
- 分析结论
- 生成时间

**功能点**：
- [ ] 报表查询和预览
- [ ] 报表打印
- [ ] 报表导出（Excel、PDF、Word）
- [ ] 报表邮件发送
- [ ] 报表定时生成

#### 2.6.2 自定义报表
**功能描述**：允许用户自定义报表

**自定义内容**：
- 报表名称
- 报表周期（日、周、月、年）
- 统计维度（空间、能源类型、设备）
- 统计指标（能耗量、同比、环比、排名等）
- 图表类型
- 报表模板

**功能点**：
- [ ] 自定义报表创建
- [ ] 报表模板管理
- [ ] 报表参数配置
- [ ] 报表预览
- [ ] 报表保存和分享

#### 2.6.3 报表定时任务
**功能描述**：定时自动生成报表

**任务配置**：
- 任务名称
- 报表类型
- 生成周期（每日、每周、每月）
- 生成时间
- 接收人（邮箱）
- 是否启用

**功能点**：
- [ ] 定时任务配置
- [ ] 定时任务启用/停用
- [ ] 报表自动生成
- [ ] 报表自动发送
- [ ] 任务执行日志

---

### 2.7 告警管理模块

#### 2.7.1 告警规则配置
**功能描述**：配置能耗告警规则

**告警类型**：
- 能耗超标告警（能耗值超过设定阈值）
- 能耗突变告警（能耗短时间内大幅波动）
- 设备离线告警（设备通讯中断）
- 数据异常告警（数据采集异常）
- 负荷异常告警（负荷异常高或低）

**规则配置**：
- 规则名称
- 告警类型
- 监控对象（建筑/区域/楼层/房间/设备）
- 能源类型
- 阈值配置
  - 单个阈值（如：>1000kWh）
  - 多个阈值（如：>1000告警，>1500严重告警）
  - 百分比阈值（如：同比增长>20%）
- 告警级别（提示、警告、严重）
- 告警方式（系统通知、短信、邮件、钉钉、企业微信）
- 接收人
- 生效时间段
- 是否启用

**功能点**：
- [ ] 告警规则列表
- [ ] 新增告警规则
- [ ] 编辑告警规则
- [ ] 删除告警规则
- [ ] 启用/停用告警规则
- [ ] 规则测试

#### 2.7.2 告警监控
**功能描述**：实时监控和触发告警

**监控流程**：
1. 实时获取能耗数据
2. 匹配告警规则
3. 判断是否触发告警条件
4. 生成告警记录
5. 发送告警通知

**功能点**：
- [ ] 实时数据监控
- [ ] 告警规则匹配
- [ ] 告警触发判断
- [ ] 告警记录生成
- [ ] 告警通知发送

#### 2.7.3 告警记录管理
**功能描述**：管理告警历史记录

**记录字段**：
- 告警ID
- 告警规则
- 告警对象
- 告警类型
- 告警级别
- 告警内容
- 告警值
- 阈值
- 告警时间
- 告警状态（待处理、处理中、已处理、已忽略）
- 处理人
- 处理时间
- 处理备注

**功能点**：
- [ ] 告警记录列表
- [ ] 告警记录查询（按时间、类型、级别、状态筛选）
- [ ] 告警详情查看
- [ ] 告警处理
- [ ] 告警忽略
- [ ] 告警统计分析
- [ ] 告警趋势分析

---

### 2.8 能效分析模块（高级功能）

#### 2.8.1 能效指标计算
**功能描述**：计算各类能效指标

**常用指标**：
- 单位面积能耗（kWh/m²）
- 人均能耗（kWh/人）
- 单位产值能耗（kWh/万元）
- 能源利用率
- 节能率
- 碳排放量（tCO₂）

**功能点**：
- [ ] 能效指标配置
- [ ] 能效指标计算
- [ ] 能效指标展示
- [ ] 能效指标对比
- [ ] 能效指标趋势

#### 2.8.2 能效评估
**功能描述**：对建筑或区域进行能效评估

**评估维度**：
- 能耗水平评估
- 用能结构评估
- 节能潜力评估
- 能效等级评估

**评估方法**：
- 对标分析（与行业标准对比）
- 历史对比
- 同类对比

**功能点**：
- [ ] 能效评估模型配置
- [ ] 能效评估报告生成
- [ ] 能效评估结果展示
- [ ] 改进建议输出

#### 2.8.3 节能建议
**功能描述**：基于数据分析提供节能建议

**建议类型**：
- 设备优化建议
- 运行策略建议
- 能源替代建议
- 技术改造建议

**功能点**：
- [ ] 智能分析能耗数据
- [ ] 识别节能机会
- [ ] 生成节能建议
- [ ] 节能效果预测

---

## 三、数据库设计

### 3.1 业务数据表（MySQL）

#### 3.1.1 建筑表 iot_energy_building
```sql
CREATE TABLE `iot_energy_building` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '建筑ID',
  `building_name` varchar(100) NOT NULL COMMENT '建筑名称',
  `building_code` varchar(50) NOT NULL COMMENT '建筑编码',
  `building_type` varchar(20) DEFAULT NULL COMMENT '建筑类型',
  `address` varchar(255) DEFAULT NULL COMMENT '建筑地址',
  `area` decimal(10,2) DEFAULT NULL COMMENT '建筑面积(m²)',
  `longitude` decimal(10,6) DEFAULT NULL COMMENT '经度',
  `latitude` decimal(10,6) DEFAULT NULL COMMENT '纬度',
  `image_url` varchar(500) DEFAULT NULL COMMENT '建筑图片',
  `description` text COMMENT '建筑描述',
  `sort` int(11) DEFAULT '0' COMMENT '排序',
  `status` tinyint(4) DEFAULT '1' COMMENT '状态(0停用1启用)',
  `creator` varchar(64) DEFAULT '' COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) DEFAULT '' COMMENT '更新者',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '租户编号',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_building_code` (`building_code`,`tenant_id`,`deleted`)
) ENGINE=InnoDB COMMENT='能源管理-建筑表';
```

#### 3.1.2 区域表 iot_energy_area
```sql
CREATE TABLE `iot_energy_area` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '区域ID',
  `area_name` varchar(100) NOT NULL COMMENT '区域名称',
  `area_code` varchar(50) NOT NULL COMMENT '区域编码',
  `building_id` bigint(20) NOT NULL COMMENT '所属建筑ID',
  `area_type` varchar(20) DEFAULT NULL COMMENT '区域类型',
  `area` decimal(10,2) DEFAULT NULL COMMENT '区域面积(m²)',
  `description` text COMMENT '区域描述',
  `sort` int(11) DEFAULT '0' COMMENT '排序',
  `status` tinyint(4) DEFAULT '1' COMMENT '状态(0停用1启用)',
  `creator` varchar(64) DEFAULT '' COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) DEFAULT '' COMMENT '更新者',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '租户编号',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_area_code` (`area_code`,`tenant_id`,`deleted`),
  KEY `idx_building_id` (`building_id`)
) ENGINE=InnoDB COMMENT='能源管理-区域表';
```

#### 3.1.3 楼层表 iot_energy_floor
```sql
CREATE TABLE `iot_energy_floor` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '楼层ID',
  `floor_name` varchar(100) NOT NULL COMMENT '楼层名称',
  `floor_code` varchar(50) NOT NULL COMMENT '楼层编码',
  `building_id` bigint(20) NOT NULL COMMENT '所属建筑ID',
  `area_id` bigint(20) DEFAULT NULL COMMENT '所属区域ID',
  `floor_number` int(11) NOT NULL COMMENT '楼层序号',
  `area` decimal(10,2) DEFAULT NULL COMMENT '楼层面积(m²)',
  `floor_plan_url` varchar(500) DEFAULT NULL COMMENT '楼层平面图URL',
  `description` text COMMENT '楼层描述',
  `sort` int(11) DEFAULT '0' COMMENT '排序',
  `status` tinyint(4) DEFAULT '1' COMMENT '状态(0停用1启用)',
  `creator` varchar(64) DEFAULT '' COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) DEFAULT '' COMMENT '更新者',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '租户编号',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_floor_code` (`floor_code`,`tenant_id`,`deleted`),
  KEY `idx_building_id` (`building_id`),
  KEY `idx_area_id` (`area_id`)
) ENGINE=InnoDB COMMENT='能源管理-楼层表';
```

#### 3.1.4 房间表 iot_energy_room
```sql
CREATE TABLE `iot_energy_room` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '房间ID',
  `room_name` varchar(100) NOT NULL COMMENT '房间名称',
  `room_code` varchar(50) NOT NULL COMMENT '房间编码',
  `building_id` bigint(20) NOT NULL COMMENT '所属建筑ID',
  `area_id` bigint(20) DEFAULT NULL COMMENT '所属区域ID',
  `floor_id` bigint(20) NOT NULL COMMENT '所属楼层ID',
  `room_type` varchar(20) DEFAULT NULL COMMENT '房间类型',
  `room_usage` varchar(50) DEFAULT NULL COMMENT '房间用途',
  `area` decimal(10,2) DEFAULT NULL COMMENT '房间面积(m²)',
  `position_x` int(11) DEFAULT NULL COMMENT '平面图X坐标',
  `position_y` int(11) DEFAULT NULL COMMENT '平面图Y坐标',
  `description` text COMMENT '房间描述',
  `sort` int(11) DEFAULT '0' COMMENT '排序',
  `status` tinyint(4) DEFAULT '1' COMMENT '状态(0停用1启用)',
  `creator` varchar(64) DEFAULT '' COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) DEFAULT '' COMMENT '更新者',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '租户编号',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_room_code` (`room_code`,`tenant_id`,`deleted`),
  KEY `idx_building_id` (`building_id`),
  KEY `idx_floor_id` (`floor_id`)
) ENGINE=InnoDB COMMENT='能源管理-房间表';
```

#### 3.1.5 能源类型表 iot_energy_type
```sql
CREATE TABLE `iot_energy_type` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '能源类型ID',
  `energy_name` varchar(50) NOT NULL COMMENT '能源名称',
  `energy_code` varchar(30) NOT NULL COMMENT '能源编码',
  `parent_id` bigint(20) DEFAULT '0' COMMENT '父级能源ID',
  `unit` varchar(20) NOT NULL COMMENT '计量单位',
  `coal_conversion_factor` decimal(10,4) DEFAULT NULL COMMENT '折标煤系数',
  `carbon_emission_factor` decimal(10,4) DEFAULT NULL COMMENT '碳排放系数',
  `icon` varchar(100) DEFAULT NULL COMMENT '能源图标',
  `color` varchar(20) DEFAULT NULL COMMENT '图表颜色',
  `description` text COMMENT '能源描述',
  `sort` int(11) DEFAULT '0' COMMENT '排序',
  `status` tinyint(4) DEFAULT '1' COMMENT '状态(0停用1启用)',
  `creator` varchar(64) DEFAULT '' COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) DEFAULT '' COMMENT '更新者',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '租户编号',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_energy_code` (`energy_code`,`tenant_id`,`deleted`)
) ENGINE=InnoDB COMMENT='能源管理-能源类型表';
```

#### 3.1.6 计量点表 iot_energy_meter
```sql
CREATE TABLE `iot_energy_meter` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '计量点ID',
  `meter_name` varchar(100) NOT NULL COMMENT '计量点名称',
  `meter_code` varchar(50) NOT NULL COMMENT '计量点编码',
  `energy_type_id` bigint(20) NOT NULL COMMENT '能源类型ID',
  `device_id` bigint(20) DEFAULT NULL COMMENT '关联设备ID',
  `device_property` varchar(100) DEFAULT NULL COMMENT '设备属性标识符',
  `building_id` bigint(20) DEFAULT NULL COMMENT '所属建筑ID',
  `area_id` bigint(20) DEFAULT NULL COMMENT '所属区域ID',
  `floor_id` bigint(20) DEFAULT NULL COMMENT '所属楼层ID',
  `room_id` bigint(20) DEFAULT NULL COMMENT '所属房间ID',
  `meter_level` tinyint(4) DEFAULT '1' COMMENT '计量点级别(1一级2二级3三级)',
  `parent_id` bigint(20) DEFAULT '0' COMMENT '父级计量点ID',
  `ratio` decimal(10,4) DEFAULT '1.0000' COMMENT '计量倍率',
  `is_virtual` bit(1) DEFAULT b'0' COMMENT '是否虚拟表',
  `calc_formula` varchar(500) DEFAULT NULL COMMENT '计算公式',
  `description` text COMMENT '计量点描述',
  `sort` int(11) DEFAULT '0' COMMENT '排序',
  `status` tinyint(4) DEFAULT '1' COMMENT '状态(0停用1启用)',
  `creator` varchar(64) DEFAULT '' COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) DEFAULT '' COMMENT '更新者',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '租户编号',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_meter_code` (`meter_code`,`tenant_id`,`deleted`),
  KEY `idx_energy_type_id` (`energy_type_id`),
  KEY `idx_device_id` (`device_id`),
  KEY `idx_building_id` (`building_id`)
) ENGINE=InnoDB COMMENT='能源管理-计量点表';
```

#### 3.1.7 能耗统计表 iot_energy_statistics
```sql
CREATE TABLE `iot_energy_statistics` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '统计ID',
  `stat_time` datetime NOT NULL COMMENT '统计时间',
  `stat_period` varchar(10) NOT NULL COMMENT '统计周期(minute/hour/day/month)',
  `meter_id` bigint(20) NOT NULL COMMENT '计量点ID',
  `energy_type_id` bigint(20) NOT NULL COMMENT '能源类型ID',
  `building_id` bigint(20) DEFAULT NULL COMMENT '建筑ID',
  `area_id` bigint(20) DEFAULT NULL COMMENT '区域ID',
  `floor_id` bigint(20) DEFAULT NULL COMMENT '楼层ID',
  `room_id` bigint(20) DEFAULT NULL COMMENT '房间ID',
  `start_value` decimal(15,4) DEFAULT NULL COMMENT '起始值',
  `end_value` decimal(15,4) DEFAULT NULL COMMENT '结束值',
  `consumption` decimal(15,4) DEFAULT NULL COMMENT '能耗量',
  `max_value` decimal(15,4) DEFAULT NULL COMMENT '最大值',
  `min_value` decimal(15,4) DEFAULT NULL COMMENT '最小值',
  `avg_value` decimal(15,4) DEFAULT NULL COMMENT '平均值',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `tenant_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '租户编号',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_stat` (`meter_id`,`stat_time`,`stat_period`,`tenant_id`),
  KEY `idx_stat_time` (`stat_time`),
  KEY `idx_building_id` (`building_id`),
  KEY `idx_energy_type_id` (`energy_type_id`)
) ENGINE=InnoDB COMMENT='能源管理-能耗统计表';
```

#### 3.1.8 告警规则表 iot_energy_alert_rule
```sql
CREATE TABLE `iot_energy_alert_rule` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '规则ID',
  `rule_name` varchar(100) NOT NULL COMMENT '规则名称',
  `rule_code` varchar(50) NOT NULL COMMENT '规则编码',
  `alert_type` varchar(20) NOT NULL COMMENT '告警类型',
  `object_type` varchar(20) NOT NULL COMMENT '监控对象类型',
  `object_id` bigint(20) DEFAULT NULL COMMENT '监控对象ID',
  `energy_type_id` bigint(20) DEFAULT NULL COMMENT '能源类型ID',
  `threshold_config` text COMMENT '阈值配置(JSON)',
  `alert_level` varchar(10) DEFAULT 'warning' COMMENT '告警级别',
  `alert_method` varchar(100) DEFAULT NULL COMMENT '告警方式',
  `receivers` varchar(500) DEFAULT NULL COMMENT '接收人',
  `effective_time` varchar(100) DEFAULT NULL COMMENT '生效时间段',
  `description` text COMMENT '规则描述',
  `status` tinyint(4) DEFAULT '1' COMMENT '状态(0停用1启用)',
  `creator` varchar(64) DEFAULT '' COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) DEFAULT '' COMMENT '更新者',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '租户编号',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_rule_code` (`rule_code`,`tenant_id`,`deleted`)
) ENGINE=InnoDB COMMENT='能源管理-告警规则表';
```

#### 3.1.9 告警记录表 iot_energy_alert_record
```sql
CREATE TABLE `iot_energy_alert_record` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '告警ID',
  `rule_id` bigint(20) NOT NULL COMMENT '规则ID',
  `rule_name` varchar(100) NOT NULL COMMENT '规则名称',
  `alert_type` varchar(20) NOT NULL COMMENT '告警类型',
  `alert_level` varchar(10) DEFAULT 'warning' COMMENT '告警级别',
  `object_type` varchar(20) NOT NULL COMMENT '告警对象类型',
  `object_id` bigint(20) DEFAULT NULL COMMENT '告警对象ID',
  `object_name` varchar(100) DEFAULT NULL COMMENT '告警对象名称',
  `alert_content` text COMMENT '告警内容',
  `alert_value` decimal(15,4) DEFAULT NULL COMMENT '告警值',
  `threshold_value` decimal(15,4) DEFAULT NULL COMMENT '阈值',
  `alert_time` datetime NOT NULL COMMENT '告警时间',
  `alert_status` varchar(20) DEFAULT 'pending' COMMENT '处理状态',
  `handler` varchar(64) DEFAULT NULL COMMENT '处理人',
  `handle_time` datetime DEFAULT NULL COMMENT '处理时间',
  `handle_remark` text COMMENT '处理备注',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `tenant_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '租户编号',
  PRIMARY KEY (`id`),
  KEY `idx_rule_id` (`rule_id`),
  KEY `idx_alert_time` (`alert_time`),
  KEY `idx_alert_status` (`alert_status`)
) ENGINE=InnoDB COMMENT='能源管理-告警记录表';
```

#### 3.1.10 报表定时任务表 iot_energy_report_task
```sql
CREATE TABLE `iot_energy_report_task` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '任务ID',
  `task_name` varchar(100) NOT NULL COMMENT '任务名称',
  `report_type` varchar(20) NOT NULL COMMENT '报表类型',
  `report_config` text COMMENT '报表配置(JSON)',
  `schedule_type` varchar(20) NOT NULL COMMENT '执行周期',
  `schedule_time` varchar(50) DEFAULT NULL COMMENT '执行时间',
  `receivers` varchar(500) DEFAULT NULL COMMENT '接收人邮箱',
  `last_execute_time` datetime DEFAULT NULL COMMENT '上次执行时间',
  `next_execute_time` datetime DEFAULT NULL COMMENT '下次执行时间',
  `status` tinyint(4) DEFAULT '1' COMMENT '状态(0停用1启用)',
  `creator` varchar(64) DEFAULT '' COMMENT '创建者',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` varchar(64) DEFAULT '' COMMENT '更新者',
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `deleted` bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
  `tenant_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '租户编号',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB COMMENT='能源管理-报表定时任务表';
```

### 3.2 时序数据表（TDengine）

#### 3.2.1 能源实时数据超级表
```sql
-- TDengine超级表
CREATE STABLE energy_realtime_data (
  ts TIMESTAMP,                    
  meter_id BIGINT,                 
  instant_power DOUBLE,            
  cumulative_value DOUBLE,         
  voltage DOUBLE,                  
  current DOUBLE,                  
  power_factor DOUBLE,             
  data_quality TINYINT             
) TAGS (
  energy_type_id BIGINT,           
  building_id BIGINT,              
  area_id BIGINT,                  
  floor_id BIGINT,                 
  room_id BIGINT,                  
  tenant_id BIGINT                 
);
```

---

## 四、接口设计

### 4.1 空间管理接口

#### 建筑管理
- `GET /admin-api/iot/energy/building/page` - 建筑分页列表
- `GET /admin-api/iot/energy/building/get` - 获取建筑详情
- `GET /admin-api/iot/energy/building/tree` - 获取建筑树形结构
- `POST /admin-api/iot/energy/building/create` - 新增建筑
- `PUT /admin-api/iot/energy/building/update` - 更新建筑
- `DELETE /admin-api/iot/energy/building/delete` - 删除建筑

#### 区域管理
- `GET /admin-api/iot/energy/area/page` - 区域分页列表
- `GET /admin-api/iot/energy/area/list` - 区域列表（按建筑）
- `POST /admin-api/iot/energy/area/create` - 新增区域
- `PUT /admin-api/iot/energy/area/update` - 更新区域
- `DELETE /admin-api/iot/energy/area/delete` - 删除区域

#### 楼层管理
- `GET /admin-api/iot/energy/floor/page` - 楼层分页列表
- `GET /admin-api/iot/energy/floor/list` - 楼层列表（按建筑/区域）
- `POST /admin-api/iot/energy/floor/create` - 新增楼层
- `PUT /admin-api/iot/energy/floor/update` - 更新楼层
- `DELETE /admin-api/iot/energy/floor/delete` - 删除楼层
- `POST /admin-api/iot/energy/floor/upload-plan` - 上传楼层平面图

#### 房间管理
- `GET /admin-api/iot/energy/room/page` - 房间分页列表
- `GET /admin-api/iot/energy/room/list` - 房间列表（按楼层）
- `POST /admin-api/iot/energy/room/create` - 新增房间
- `PUT /admin-api/iot/energy/room/update` - 更新房间
- `DELETE /admin-api/iot/energy/room/delete` - 删除房间

### 4.2 能源管理接口

#### 能源类型
- `GET /admin-api/iot/energy/type/page` - 能源类型分页列表
- `GET /admin-api/iot/energy/type/tree` - 能源类型树形结构
- `POST /admin-api/iot/energy/type/create` - 新增能源类型
- `PUT /admin-api/iot/energy/type/update` - 更新能源类型
- `DELETE /admin-api/iot/energy/type/delete` - 删除能源类型

#### 计量点管理
- `GET /admin-api/iot/energy/meter/page` - 计量点分页列表
- `GET /admin-api/iot/energy/meter/tree` - 计量点树形结构
- `POST /admin-api/iot/energy/meter/create` - 新增计量点
- `PUT /admin-api/iot/energy/meter/update` - 更新计量点
- `DELETE /admin-api/iot/energy/meter/delete` - 删除计量点
- `POST /admin-api/iot/energy/meter/bind-device` - 绑定设备

### 4.3 数据统计接口

#### 实时监控
- `GET /admin-api/iot/energy/statistics/realtime` - 实时能耗数据
- `GET /admin-api/iot/energy/statistics/overview` - 能耗总览
- `GET /admin-api/iot/energy/statistics/device-status` - 设备在线状态

#### 历史数据
- `GET /admin-api/iot/energy/statistics/history` - 历史能耗查询
- `GET /admin-api/iot/energy/statistics/trend` - 能耗趋势
- `GET /admin-api/iot/energy/statistics/comparison` - 能耗对比

#### 统计分析
- `GET /admin-api/iot/energy/statistics/sub-item` - 分项能耗统计
- `GET /admin-api/iot/energy/statistics/yoy-mom` - 同比环比分析
- `GET /admin-api/iot/energy/statistics/ranking` - 能耗排名
- `GET /admin-api/iot/energy/statistics/load-curve` - 负荷曲线

### 4.4 可视化接口

#### 大屏数据
- `GET /admin-api/iot/energy/dashboard/overview` - 大屏总览数据
- `GET /admin-api/iot/energy/dashboard/chart-data` - 图表数据

### 4.5 报表接口

- `GET /admin-api/iot/energy/report/list` - 报表列表
- `POST /admin-api/iot/energy/report/generate` - 生成报表
- `GET /admin-api/iot/energy/report/export` - 导出报表
- `GET /admin-api/iot/energy/report/task/page` - 定时任务列表
- `POST /admin-api/iot/energy/report/task/create` - 创建定时任务
- `PUT /admin-api/iot/energy/report/task/update` - 更新定时任务

### 4.6 告警接口

#### 告警规则
- `GET /admin-api/iot/energy/alert/rule/page` - 告警规则列表
- `POST /admin-api/iot/energy/alert/rule/create` - 创建告警规则
- `PUT /admin-api/iot/energy/alert/rule/update` - 更新告警规则
- `DELETE /admin-api/iot/energy/alert/rule/delete` - 删除告警规则

#### 告警记录
- `GET /admin-api/iot/energy/alert/record/page` - 告警记录列表
- `GET /admin-api/iot/energy/alert/record/statistics` - 告警统计
- `PUT /admin-api/iot/energy/alert/record/handle` - 处理告警

---

## 五、开发计划

### 第一阶段：基础设施搭建（预计2-3天）

**目标**：搭建模块基础架构和数据库

**任务清单**：
- [ ] 创建能源管理模块代码结构
  - [ ] controller包
  - [ ] service包
  - [ ] dal包（mapper、dataobject）
  - [ ] convert包
  - [ ] vo包
- [ ] 创建数据库表结构
  - [ ] 执行建表SQL脚本
  - [ ] 生成MyBatis Mapper
- [ ] 配置TDengine数据源
- [ ] 创建基础工具类和常量定义

**交付物**：
- 完整的模块代码结构
- 数据库表和索引
- 基础配置文件

---

### 第二阶段:空间层级管理（预计3-4天）

**目标**：实现建筑、区域、楼层、房间的完整管理功能

**任务清单**：
- [ ] 建筑管理
  - [ ] 后端接口实现（CRUD）
  - [ ] 前端页面（列表、表单、详情）
  - [ ] 树形结构展示
- [ ] 区域管理
  - [ ] 后端接口实现
  - [ ] 前端页面
- [ ] 楼层管理
  - [ ] 后端接口实现
  - [ ] 前端页面
  - [ ] 平面图上传功能
- [ ] 房间管理
  - [ ] 后端接口实现
  - [ ] 前端页面
  - [ ] 平面图标注功能（可选）
- [ ] 空间树形联动组件

**交付物**：
- 完整的空间管理功能
- 空间树形展示组件
- 管理界面

---

### 第三阶段：能源类型和计量点管理（预计2-3天）

**目标**：实现能源类型和计量点的管理

**任务清单**：
- [ ] 能源类型管理
  - [ ] 后端接口实现
  - [ ] 前端页面（树形结构）
  - [ ] 预置能源类型数据
- [ ] 计量点管理
  - [ ] 后端接口实现
  - [ ] 前端页面
  - [ ] 设备绑定功能
  - [ ] 虚拟表配置
- [ ] 计量点与空间关联
- [ ] 计量点树形结构展示

**交付物**：
- 能源类型管理功能
- 计量点管理功能
- 设备绑定功能

---

### 第四阶段：能源数据采集和存储（预计4-5天）

**目标**：实现能源数据的实时采集、存储和聚合

**任务清单**：
- [ ] 数据采集服务
  - [ ] 从设备消息中提取能源数据
  - [ ] 数据质量校验
  - [ ] 倍率换算
- [ ] 实时数据存储
  - [ ] 写入TDengine超级表
  - [ ] 缓存最新数据到Redis
- [ ] 数据聚合任务
  - [ ] 分钟级聚合定时任务
  - [ ] 小时级聚合定时任务
  - [ ] 天级聚合定时任务
  - [ ] 月级聚合定时任务
- [ ] 数据查询服务
  - [ ] 实时数据查询
  - [ ] 历史数据查询
  - [ ] 聚合数据查询

**交付物**：
- 数据采集服务
- 数据存储和聚合功能
- 数据查询接口

---

### 第五阶段：数据统计分析（预计5-6天）

**目标**：实现各类数据统计和分析功能

**任务清单**：
- [ ] 实时监控
  - [ ] 实时能耗接口
  - [ ] 能耗总览接口
  - [ ] 设备状态接口
- [ ] 历史数据查询
  - [ ] 多维度查询接口
  - [ ] 时间范围查询
  - [ ] 空间层级查询
- [ ] 分项能耗统计
  - [ ] 分项统计接口
  - [ ] 占比计算
- [ ] 同比环比分析
  - [ ] 同比计算逻辑
  - [ ] 环比计算逻辑
  - [ ] 趋势分析
- [ ] 能耗排名
  - [ ] 排名计算
  - [ ] TOP N查询
- [ ] 负荷分析
  - [ ] 负荷曲线查询
  - [ ] 峰谷分析

**交付物**：
- 完整的统计分析接口
- 数据分析算法
- 接口文档

---

### 第六阶段：可视化展示（预计6-7天）

**目标**：实现前端可视化界面和图表

**任务清单**：
- [ ] 能耗监控大屏
  - [ ] 大屏布局设计
  - [ ] 总览卡片组件
  - [ ] 实时趋势图
  - [ ] 分项占比图
  - [ ] 排名图表
  - [ ] 告警信息展示
- [ ] 图表组件封装
  - [ ] 折线图组件
  - [ ] 柱状图组件
  - [ ] 饼图组件
  - [ ] 仪表盘组件
- [ ] 数据查询页面
  - [ ] 查询条件表单
  - [ ] 数据表格
  - [ ] 图表展示
  - [ ] 导出功能
- [ ] 空间树形组件
  - [ ] 树形展示
  - [ ] 节点点击查看能耗
- [ ] 地图展示（可选）
  - [ ] 建筑地图标注
  - [ ] 热力图

**交付物**：
- 能耗监控大屏
- 数据查询页面
- 图表组件库
- 空间树形组件

---

### 第七阶段：报表管理（预计3-4天）

**目标**：实现报表生成和管理功能

**任务清单**：
- [ ] 预定义报表
  - [ ] 日报模板
  - [ ] 月报模板
  - [ ] 年报模板
  - [ ] 报表生成逻辑
- [ ] 报表导出
  - [ ] Excel导出
  - [ ] PDF导出（可选）
- [ ] 定时任务
  - [ ] 定时任务配置
  - [ ] 报表自动生成
  - [ ] 邮件发送（可选）
- [ ] 前端页面
  - [ ] 报表查询页面
  - [ ] 报表预览
  - [ ] 定时任务管理

**交付物**：
- 报表生成功能
- 报表导出功能
- 定时任务配置

---

### 第八阶段：告警管理（预计3-4天）

**目标**：实现能耗告警功能

**任务清单**：
- [ ] 告警规则管理
  - [ ] 后端接口
  - [ ] 前端页面
  - [ ] 规则配置
- [ ] 告警监控服务
  - [ ] 实时数据监控
  - [ ] 规则匹配引擎
  - [ ] 告警触发
  - [ ] 告警通知
- [ ] 告警记录管理
  - [ ] 告警记录查询
  - [ ] 告警处理
  - [ ] 告警统计
- [ ] 前端页面
  - [ ] 告警规则列表
  - [ ] 告警记录列表
  - [ ] 告警详情

**交付物**：
- 告警规则配置功能
- 告警监控服务
- 告警记录管理

---

### 第九阶段：能效分析（可选，预计2-3天）

**目标**：实现能效指标计算和分析

**任务清单**：
- [ ] 能效指标配置
  - [ ] 指标定义
  - [ ] 指标计算公式
- [ ] 能效计算服务
  - [ ] 单位面积能耗
  - [ ] 人均能耗
  - [ ] 碳排放计算
- [ ] 能效评估
  - [ ] 评估模型
  - [ ] 评估报告
- [ ] 前端页面
  - [ ] 能效指标展示
  - [ ] 能效分析图表

**交付物**：
- 能效指标计算
- 能效评估功能
- 能效分析页面

---

### 第十阶段：测试和优化（预计3-4天）

**目标**：全面测试和性能优化

**任务清单**：
- [ ] 功能测试
  - [ ] 单元测试
  - [ ] 接口测试
  - [ ] 前端页面测试
- [ ] 性能测试
  - [ ] 数据查询性能
  - [ ] 大数据量测试
  - [ ] 并发测试
- [ ] 性能优化
  - [ ] SQL优化
  - [ ] 缓存优化
  - [ ] 前端性能优化
- [ ] Bug修复
- [ ] 文档完善
  - [ ] 接口文档
  - [ ] 使用手册
  - [ ] 部署文档

**交付物**：
- 测试报告
- 性能优化报告
- 完整文档

---

## 六、技术要点

### 6.1 数据采集

**采集频率**：
- 重要设备：1分钟/次
- 一般设备：5分钟/次
- 辅助设备：15分钟/次

**数据来源**：
- 复用现有IoT平台的设备消息
- 通过物模型标识符识别能源数据
- 支持多种协议设备（Modbus、MQTT等）

### 6.2 数据存储

**存储策略**：
- 实时数据：TDengine（保留1个月）
- 分钟聚合：TDengine（保留3个月）
- 小时聚合：MySQL（保留1年）
- 天聚合：MySQL（永久保存）
- 月聚合：MySQL（永久保存）

**索引优化**：
- 按时间分区
- 建筑、能源类型、计量点建立索引
- 复合索引优化查询性能

### 6.3 数据查询优化

**缓存策略**：
- 实时数据缓存到Redis（TTL 5分钟）
- 统计数据缓存（TTL 1小时）
- 配置数据缓存（TTL 24小时）

**查询优化**：
- 使用聚合表减少计算
- 分页查询大数据量
- 异步处理复杂统计

### 6.4 实时推送

**WebSocket推送**：
- 实时能耗数据推送
- 告警消息推送
- 设备状态推送

### 6.5 权限控制

**数据权限**：
- 按租户隔离数据
- 按角色控制数据范围
- 按部门/项目分配建筑权限

---

## 七、前端技术选型

### 7.1 UI框架
- Element Plus（表格、表单、对话框等）
- 自定义组件（树形选择器、层级选择器等）

### 7.2 图表库
- ECharts 5.x（主要图表库）
- DataV（大屏可视化）

### 7.3 其他库
- Day.js（时间处理）
- xlsx（Excel导出）
- html2canvas + jsPDF（PDF导出）

---

## 八、风险和注意事项

### 8.1 性能风险
- 大量设备实时数据写入压力
  - 解决方案：批量写入、异步处理
- 复杂统计查询性能
  - 解决方案：预聚合、缓存、索引优化

### 8.2 数据准确性
- 设备数据异常处理
  - 解决方案：数据校验、异常标记、人工审核
- 累计值回退处理
  - 解决方案：检测回退、重新计算

### 8.3 扩展性
- 支持更多能源类型
  - 解决方案：能源类型配置化
- 支持更多统计维度
  - 解决方案：灵活的查询条件组合

---

## 九、后续扩展方向

### 9.1 AI智能分析
- 能耗预测（基于历史数据）
- 异常检测（机器学习）
- 节能建议（智能推荐）

### 9.2 移动端
- 移动端监控App
- 微信小程序
- 告警推送

### 9.3 第三方集成
- 与ERP系统集成
- 与BIM系统集成
- 与能源管理平台对接

---

## 十、总结

本需求计划详细规划了能源管理模块的完整功能，涵盖了空间管理、能源采集、数据统计、可视化展示、报表管理、告警管理等核心功能。

**预计总开发周期**：30-40天

**核心特性**：
1. 完整的空间层级体系
2. 灵活的能源类型配置
3. 强大的数据统计分析
4. 丰富的可视化展示
5. 智能的告警监控
6. 完善的报表管理

该模块将与现有IoT平台深度集成，复用设备管理、数据采集、消息总线等基础能力，形成完整的工业能源管理解决方案。
