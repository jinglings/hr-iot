# 设备影子使用指南

## 概述

设备影子（Device Shadow）是设备在云端的虚拟表示，用于解决设备不稳定连接和离线场景下的状态同步问题。

### 核心概念

#### 1. 期望状态（Desired State）
- **定义**：云端希望设备达到的目标状态
- **来源**：应用程序或用户通过云端API设置
- **用途**：当设备离线时，期望状态保存在云端；设备上线后自动同步

#### 2. 实际状态（Reported State）
- **定义**：设备实际运行的当前状态
- **来源**：设备主动上报到云端
- **用途**：反映设备的真实情况

#### 3. 差量状态（Delta State）
- **定义**：期望状态与实际状态的差异
- **计算**：delta = desired - reported
- **用途**：告诉设备需要改变哪些属性

## 工作原理

```
┌─────────┐                    ┌──────────┐                   ┌──────┐
│  应用    │                    │  云端     │                   │ 设备  │
│         │                    │  影子     │                   │      │
└────┬────┘                    └────┬─────┘                   └───┬──┘
     │                              │                              │
     │  1. 更新期望状态              │                              │
     │────────────────────────────>│                              │
     │                              │                              │
     │                              │  2. 设备上线/查询影子         │
     │                              │<─────────────────────────────│
     │                              │                              │
     │                              │  3. 返回差量状态(delta)       │
     │                              │──────────────────────────────>│
     │                              │                              │
     │                              │  4. 设备执行变更              │
     │                              │                              ├───┐
     │                              │                              │   │
     │                              │                              │<──┘
     │                              │  5. 上报实际状态              │
     │                              │<─────────────────────────────│
     │                              │                              │
     │                              │  6. 自动清除已满足的期望      │
     │                              ├───┐                          │
     │                              │   │                          │
     │                              │<──┘                          │
```

## API使用示例

### 1. 获取设备影子

```http
GET /iot/device-shadow/get?deviceId=1024
```

响应示例：
```json
{
  "code": 0,
  "data": {
    "id": 1,
    "deviceId": 1024,
    "desired": {
      "temperature": 25,
      "mode": "auto"
    },
    "reported": {
      "temperature": 22,
      "mode": "manual"
    },
    "delta": {
      "temperature": 25,
      "mode": "auto"
    },
    "version": 5,
    "desiredVersion": 3,
    "reportedVersion": 2,
    "lastDesiredTime": "2025-01-17T10:30:00",
    "lastReportedTime": "2025-01-17T10:25:00"
  }
}
```

### 2. 更新期望状态（云端下发指令）

```http
PUT /iot/device-shadow/update-desired
Content-Type: application/json

{
  "deviceId": 1024,
  "desired": {
    "temperature": 26,
    "fan_speed": 3
  },
  "version": 5
}
```

**说明**：
- `version`字段用于乐观锁，防止并发冲突
- 期望状态会与已有状态合并，而非完全替换
- 设备下次连接时会收到差量更新

### 3. 设备上报实际状态

```http
PUT /iot/device-shadow/update-reported
Content-Type: application/json

{
  "deviceId": 1024,
  "reported": {
    "temperature": 26,
    "fan_speed": 3,
    "humidity": 60
  }
}
```

**自动同步逻辑**：
- 当上报的实际状态与期望状态一致时，系统会自动清除该期望状态
- 例如：上报`temperature=26`后，期望状态中的`temperature`会被自动删除

### 4. 获取差量状态

```http
GET /iot/device-shadow/get-delta?deviceId=1024
```

响应示例：
```json
{
  "code": 0,
  "data": {
    "temperature": 26,
    "mode": "auto"
  }
}
```

**用途**：设备可以只获取需要变更的属性，减少数据传输量

### 5. 删除期望状态属性

```http
DELETE /iot/device-shadow/delete-desired-property?deviceId=1024&property=mode
```

**用途**：手动清除某个期望状态，例如用户取消了之前的设置

### 6. 查询影子变更历史

```http
GET /iot/device-shadow/history?deviceId=1024&pageNo=1&pageSize=10
```

响应示例：
```json
{
  "code": 0,
  "data": {
    "list": [
      {
        "id": 1,
        "deviceId": 1024,
        "changeType": "DESIRED",
        "beforeState": {"temperature": 25},
        "afterState": {"temperature": 26},
        "deltaState": {"temperature": 26},
        "version": 6,
        "createTime": "2025-01-17T10:30:00"
      },
      {
        "id": 2,
        "deviceId": 1024,
        "changeType": "REPORTED",
        "beforeState": {"temperature": 22},
        "afterState": {"temperature": 26},
        "deltaState": {"temperature": 26},
        "version": 5,
        "createTime": "2025-01-17T10:25:00"
      }
    ],
    "total": 2
  }
}
```

### 7. 清除设备影子

```http
DELETE /iot/device-shadow/clear?deviceId=1024
```

**注意**：此操作会删除设备影子及所有历史记录，请谨慎使用

## 使用场景

### 场景1：设备离线控制

**问题**：用户想要设置空调温度为26度，但设备当前离线

**解决方案**：
1. 云端更新期望状态：`{" temperature": 26}`
2. 期望状态保存在影子中
3. 设备上线后，查询影子获取差量：`delta = {temperature: 26}`
4. 设备执行温度调整
5. 设备上报实际状态：`{temperature: 26}`
6. 系统自动清除期望状态

```javascript
// 云端操作（用户设置）
PUT /iot/device-shadow/update-desired
{
  "deviceId": 1024,
  "desired": {"temperature": 26}
}

// 设备上线后查询
GET /iot/device-shadow/get-delta?deviceId=1024
// 响应: {"temperature": 26}

// 设备执行后上报
PUT /iot/device-shadow/update-reported
{
  "deviceId": 1024,
  "reported": {"temperature": 26}
}
// 系统自动清除 desired.temperature
```

### 场景2：批量设备配置

**问题**：需要批量更新1000台设备的运行模式

**解决方案**：
1. 遍历设备，为每个设备设置期望状态
2. 无需等待设备在线
3. 设备在线后自动同步配置

```python
# 批量设置期望状态
devices = [1001, 1002, 1003, ...]
for device_id in devices:
    update_desired({
        "deviceId": device_id,
        "desired": {"mode": "eco", "schedule": "auto"}
    })
```

### 场景3：状态审计追踪

**问题**：需要了解设备状态的历史变化情况

**解决方案**：
查询设备影子变更历史

```http
GET /iot/device-shadow/history?deviceId=1024&pageNo=1&pageSize=20
```

可以追溯：
- 谁在什么时间修改了期望状态
- 设备何时上报了实际状态
- 每次变更的差量是什么

### 场景4：弱网环境同步

**问题**：设备网络不稳定，经常断线重连

**解决方案**：
- 设备上线时先查询影子差量
- 只同步有差异的部分，减少数据量
- 上报完成后自动清除期望状态

```javascript
// 设备上线逻辑
function onDeviceOnline(deviceId) {
  // 1. 获取差量
  const delta = getDelta(deviceId);

  // 2. 应用差量
  if (Object.keys(delta).length > 0) {
    applyConfig(delta);
  }

  // 3. 上报当前状态
  reportState(deviceId, getCurrentState());
}
```

## 最佳实践

### 1. 版本号控制

使用版本号防止并发冲突：

```javascript
// 读取影子
const shadow = getDeviceShadow(deviceId);

// 更新期望状态时传入版本号
updateDesired({
  deviceId: deviceId,
  desired: {temperature: 26},
  version: shadow.version  // 乐观锁
});
```

### 2. 差量上报

设备不需要上报所有状态，只上报变化的部分：

```javascript
// ❌ 不推荐：每次上报所有状态
reportState({
  temperature: 26,
  humidity: 60,
  pressure: 1013,
  // ...100个属性
});

// ✅ 推荐：只上报变化的部分
reportState({
  temperature: 26  // 只上报温度变化
});
```

### 3. 定期同步

对于关键设备，建议定期全量同步：

```javascript
// 每小时全量同步一次
setInterval(() => {
  const fullState = getFullDeviceState();
  reportState(deviceId, fullState);
}, 3600000);
```

### 4. 合理使用期望状态

期望状态适用于：
- ✅ 可控属性（温度、模式、开关等）
- ✅ 需要持久化的设置
- ✅ 离线设备需要同步的配置

不适用于：
- ❌ 只读属性（传感器数据）
- ❌ 实时性要求高的控制
- ❌ 一次性指令

### 5. 监控影子大小

建议：
- 期望状态 < 1KB
- 实际状态 < 1KB
- 避免存储大量历史数据

```javascript
// ❌ 不推荐：存储大量数据
{
  "temperature_history": [26, 25.9, 25.8, ...]  // 1000个数据点
}

// ✅ 推荐：只存储当前值
{
  "temperature": 26
}
```

## 数据结构说明

### 影子JSON结构

```json
{
  "desired": {
    "property1": value1,
    "property2": value2
  },
  "reported": {
    "property1": value1,
    "property3": value3
  },
  "delta": {
    "property2": value2
  },
  "metadata": {
    "desired": {
      "property1": {"timestamp": 1642410000}
    },
    "reported": {
      "property1": {"timestamp": 1642410100}
    }
  },
  "version": 5
}
```

### 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| desired | Object | 期望状态 - 云端希望设备达到的状态 |
| reported | Object | 实际状态 - 设备当前实际状态 |
| delta | Object | 差量状态 - 期望与实际的差异 |
| metadata | Object | 元数据 - 包含每个属性的更新时间 |
| version | Integer | 整体版本号 - 每次更新递增 |
| desiredVersion | Integer | 期望状态版本号 |
| reportedVersion | Integer | 实际状态版本号 |

## 性能考虑

- **并发控制**：使用版本号实现乐观锁
- **历史记录**：默认保留90天，可配置
- **查询性能**：设备ID建立唯一索引
- **存储优化**：JSON字段使用压缩存储

## 安全考虑

1. **权限控制**：
   - 期望状态更新需要`iot:device:update`权限
   - 实际状态上报需要设备身份认证

2. **数据验证**：
   - 状态JSON大小限制：1KB
   - 属性名长度限制：64字符
   - 版本号冲突检测

3. **审计日志**：
   - 所有变更记录到历史表
   - 包含操作者、时间、变更内容

## 故障处理

### Q1: 版本号冲突
**问题**：更新时报错"版本号冲突"

**解决**：
```javascript
try {
  updateDesired(req);
} catch (e) {
  if (e.message.includes("版本号冲突")) {
    // 重新获取最新影子
    const shadow = getDeviceShadow(deviceId);
    // 使用最新版本号重试
    req.version = shadow.version;
    updateDesired(req);
  }
}
```

### Q2: 影子不自动清除
**问题**：设备已上报状态，但期望状态没有被清除

**可能原因**：
1. 上报的值类型不匹配（如：期望是数字26，上报是字符串"26"）
2. 上报的属性名不完全匹配

**解决**：
```javascript
// ❌ 错误：类型不匹配
updateReported({
  deviceId: 1024,
  reported: {temperature: "26"}  // 字符串
});

// ✅ 正确：类型一致
updateReported({
  deviceId: 1024,
  reported: {temperature: 26}  // 数字
});
```

### Q3: 差量状态为空
**问题**：明明期望状态有值，但差量为空

**原因**：期望状态与实际状态完全一致

**验证**：
```javascript
// 检查完整影子
const shadow = getDeviceShadow(deviceId);
console.log("desired:", shadow.desired);
console.log("reported:", shadow.reported);
console.log("delta:", shadow.delta);
```

## 与其他功能集成

### 与规则引擎集成

```json
{
  "conditions": {
    "property": "shadow.delta.temperature",
    "comparator": ">",
    "value": 0
  },
  "actions": [
    {
      "type": "ALERT",
      "message": "设备温度期望值已更新"
    }
  ]
}
```

### 与设备事件集成

设备可以订阅影子变更事件：

```javascript
// 订阅差量变更
subscribeShadowDelta(deviceId, (delta) => {
  console.log("收到新的期望状态:", delta);
  applyConfig(delta);
});
```

---

**版本**: v1.0.0
**更新时间**: 2025-01-17
**作者**: AI Assistant
