# 能源管理模块 - 高级功能开发计划

## 概述

本文档规划了能源管理模块的高级功能开发计划，包括数据可视化、告警管理、报表管理、能效分析和数据导出等功能。

---

## 第五阶段：数据可视化和大屏展示（预计2-3天）

### 5.1 能耗总览API

**功能描述**：为大屏展示提供总览数据

**数据内容**：
- 今日能耗总量（电/水/气/热/冷）
- 本月能耗总量
- 实时功率
- 同比增长率
- 环比增长率
- 在线设备数/总设备数

**接口**：
- `GET /admin-api/iot/energy/dashboard/overview` - 获取能耗总览数据

### 5.2 实时监控数据API

**功能描述**：实时监控各建筑、区域的能耗情况

**数据内容**：
- 各建筑实时功率
- Top 10 能耗排名
- 告警数量统计
- 设备在线状态

**接口**：
- `GET /admin-api/iot/energy/dashboard/realtime` - 获取实时监控数据
- `GET /admin-api/iot/energy/dashboard/ranking` - 获取能耗排名

### 5.3 趋势图数据API

**功能描述**：提供能耗趋势数据用于图表展示

**数据内容**：
- 24小时能耗趋势
- 7天能耗趋势
- 30天能耗趋势
- 12个月能耗趋势

**接口**：
- `GET /admin-api/iot/energy/dashboard/trend` - 获取能耗趋势数据

### 5.4 分项能耗数据API

**功能描述**：按能源类型统计分项能耗

**数据内容**：
- 电能耗占比
- 水能耗占比
- 气能耗占比
- 热能耗占比
- 冷能耗占比

**接口**：
- `GET /admin-api/iot/energy/dashboard/energy-breakdown` - 获取分项能耗数据

**交付物**：
- 能耗总览Service和Controller
- 实时监控Service和Controller
- 趋势图数据Service和Controller
- 分项能耗Service和Controller
- VO类和响应对象

---

## 第六阶段：告警管理（预计3-4天）

### 6.1 告警规则配置

**功能描述**：配置各类能耗告警规则

**告警类型**：
- threshold: 能耗超标告警
- mutation: 能耗突变告警
- offline: 设备离线告警
- abnormal: 数据异常告警

**配置内容**：
- 监控对象（建筑/区域/楼层/房间/计量点）
- 能源类型
- 阈值配置（JSON格式）
- 告警级别（info/warning/error）
- 告警方式（系统通知/短信/邮件/钉钉/企业微信）
- 接收人
- 生效时间段

**接口**：
- `POST /admin-api/iot/energy/alert/rule/create` - 创建告警规则
- `PUT /admin-api/iot/energy/alert/rule/update` - 更新告警规则
- `DELETE /admin-api/iot/energy/alert/rule/delete` - 删除告警规则
- `GET /admin-api/iot/energy/alert/rule/page` - 查询告警规则列表

### 6.2 告警检测服务

**功能描述**：实时检测能耗数据，触发告警

**检测逻辑**：
- 数据采集时同步检测
- 定时任务批量检测
- 规则引擎匹配
- 告警去重和抑制

**实现方式**：
- AlertDetectionService：告警检测服务
- AlertSuppressionService：告警抑制服务
- AlertRuleEngine：规则引擎

### 6.3 告警记录管理

**功能描述**：记录和管理告警信息

**记录内容**：
- 告警规则信息
- 告警对象
- 告警值和阈值
- 告警时间
- 处理状态（pending/processing/resolved/ignored）
- 处理人和处理时间

**接口**：
- `GET /admin-api/iot/energy/alert/record/page` - 查询告警记录
- `GET /admin-api/iot/energy/alert/record/statistics` - 告警统计
- `PUT /admin-api/iot/energy/alert/record/handle` - 处理告警

### 6.4 告警通知服务

**功能描述**：发送告警通知到各个渠道

**通知渠道**：
- 系统内通知
- 短信通知
- 邮件通知
- 钉钉通知
- 企业微信通知

**实现方式**：
- NotificationService：通知服务接口
- SystemNotificationServiceImpl：系统通知实现
- SmsNotificationServiceImpl：短信通知实现
- EmailNotificationServiceImpl：邮件通知实现
- DingTalkNotificationServiceImpl：钉钉通知实现
- WeChatWorkNotificationServiceImpl：企业微信通知实现

**交付物**：
- 告警规则DO、Mapper、Service、Controller
- 告警记录DO、Mapper、Service、Controller
- 告警检测Service
- 告警通知Service
- 告警定时任务

---

## 第七阶段：报表管理和数据导出（预计4-5天）

### 7.1 报表模板定义

**报表类型**：
- 日能耗报表
- 周能耗报表
- 月能耗报表
- 年能耗报表
- 分项能耗报表
- 同比环比报表
- 能耗排名报表

**模板配置**：
- 报表名称
- 报表周期
- 统计维度
- 统计指标
- 图表类型
- 报表样式

### 7.2 报表生成服务

**功能描述**：根据模板生成报表数据

**生成流程**：
1. 解析报表模板
2. 查询统计数据
3. 数据处理和计算
4. 生成报表结构
5. 填充报表数据

**实现方式**：
- ReportTemplateService：报表模板服务
- ReportGeneratorService：报表生成服务
- ReportDataService：报表数据服务

### 7.3 Excel导出

**功能描述**：将报表导出为Excel格式

**导出内容**：
- 报表标题和时间
- 统计数据表格
- 图表（使用ECharts或Apache POI）
- 分析结论

**技术实现**：
- Apache POI：Excel生成
- EasyExcel：简化Excel操作
- 支持.xls和.xlsx格式

### 7.4 PDF导出

**功能描述**：将报表导出为PDF格式

**导出内容**：
- 报表封面
- 统计数据表格
- 图表（转为图片）
- 分析结论
- 页眉页脚

**技术实现**：
- iText：PDF生成
- 或使用HTML模板 + wkhtmltopdf
- 支持中文字体

### 7.5 定时报表任务

**功能描述**：定时自动生成报表并发送

**任务配置**：
- 报表类型
- 生成周期（每日/每周/每月）
- 生成时间
- 接收人（邮箱）
- 是否启用

**实现方式**：
- ReportTaskService：报表任务服务
- ReportScheduleJob：报表定时任务
- 支持邮件自动发送

**接口**：
- `POST /admin-api/iot/energy/report/generate` - 生成报表
- `GET /admin-api/iot/energy/report/export/excel` - 导出Excel
- `GET /admin-api/iot/energy/report/export/pdf` - 导出PDF
- `GET /admin-api/iot/energy/report/task/page` - 查询定时任务
- `POST /admin-api/iot/energy/report/task/create` - 创建定时任务

**交付物**：
- 报表模板DO、Mapper、Service、Controller
- 报表生成Service
- Excel导出Service
- PDF导出Service
- 定时报表任务Job

---

## 第八阶段：能效分析（预计3-4天）

### 8.1 同比环比分析

**功能描述**：对比不同时期的能耗数据

**分析维度**：
- 日同比/环比（与上周同期、昨天对比）
- 月同比/环比（与去年同期、上月对比）
- 年同比（与去年对比）

**计算公式**：
- 同比增长率 = (本期值 - 去年同期值) / 去年同期值 × 100%
- 环比增长率 = (本期值 - 上期值) / 上期值 × 100%

**接口**：
- `GET /admin-api/iot/energy/analysis/yoy-mom` - 同比环比分析

### 8.2 能效指标计算

**功能描述**：计算各类能效指标

**常用指标**：
- 单位面积能耗（kWh/m²）
- 人均能耗（kWh/人）
- 单位产值能耗（kWh/万元）
- 能源利用率
- 节能率
- 碳排放量（tCO₂）

**计算逻辑**：
- 获取建筑面积、人数、产值等基础数据
- 获取能耗数据
- 根据公式计算指标
- 与行业标准对比

**接口**：
- `GET /admin-api/iot/energy/analysis/efficiency` - 能效指标查询
- `POST /admin-api/iot/energy/analysis/efficiency/calculate` - 计算能效指标

### 8.3 碳排放计算

**功能描述**：根据能耗计算碳排放量

**计算公式**：
- 碳排放量 = 能耗量 × 碳排放系数
- 不同能源类型有不同的碳排放系数

**碳排放系数**：
- 电：0.7850 kgCO₂/kWh
- 天然气：2.1650 kgCO₂/m³
- 汽油：2.9251 kgCO₂/kg
- 柴油：3.0959 kgCO₂/kg

**接口**：
- `GET /admin-api/iot/energy/analysis/carbon-emission` - 碳排放查询

### 8.4 能效评估

**功能描述**：对建筑或区域进行能效评估

**评估维度**：
- 能耗水平评估
- 用能结构评估
- 节能潜力评估
- 能效等级评估

**评估方法**：
- 对标分析（与行业标准对比）
- 历史对比（与历史数据对比）
- 同类对比（与同类建筑对比）

**评估结果**：
- 能效等级（A/B/C/D/E）
- 评分（0-100分）
- 改进建议

**接口**：
- `POST /admin-api/iot/energy/analysis/assessment` - 能效评估

**交付物**：
- 同比环比分析Service和Controller
- 能效指标Service和Controller
- 碳排放计算Service和Controller
- 能效评估Service和Controller

---

## 开发时间线

| 阶段 | 功能 | 预计时间 | 优先级 | 状态 |
|------|------|----------|--------|------|
| 第五阶段 | 数据可视化和大屏展示 | 2-3天 | 高 | ✅ 已完成 |
| 第六阶段 | 告警管理 | 3-4天 | 高 | ✅ 已完成（已有功能） |
| 第七阶段 | 报表管理和数据导出 | 4-5天 | 中 | ✅ 已完成 |
| 第八阶段 | 能效分析 | 3-4天 | 中 | ✅ 已完成 |

**总计**: 12-16天 **（全部完成）**

---

## 技术选型

### 前端
- ECharts：图表展示
- Vue3 + Element Plus：管理界面
- 大屏可视化框架：DataV

### 后端
- Apache POI / EasyExcel：Excel导出
- iText / wkhtmltopdf：PDF导出
- 定时任务：Spring @Scheduled
- 规则引擎：Drools（可选）

### 数据库
- MySQL：业务数据和统计数据
- TDengine：时序数据
- Redis：缓存和实时数据

---

## 备注

1. 每个阶段完成后进行代码提交
2. 优先实现核心功能，后续再优化
3. 告警通知的短信、邮件等需要配置第三方服务
4. PDF导出需要配置中文字体
5. 大屏展示可以使用WebSocket推送实时数据

---

## 下一步行动

建议从**第五阶段：数据可视化和大屏展示**开始实现，因为：
1. 优先级最高
2. 技术难度相对较低
3. 可以快速看到效果
4. 为后续功能提供数据基础
