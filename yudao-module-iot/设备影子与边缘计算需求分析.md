# 设备影子与边缘计算功能需求分析文档

## 文档信息

- **项目名称**: HR-IoT 平台 - 设备影子与边缘计算模块
- **文档版本**: v1.0
- **创建日期**: 2025-11-17
- **负责人**: AI Assistant
- **目标模块**: yudao-module-iot

---

## 1. 需求概述

### 1.1 背景

当前 HR-IoT 平台已实现基础的设备管理、数据采集、规则引擎等核心功能。为了进一步提升平台的实用性和竞争力,需要增加以下高级功能:

1. **设备影子 (Device Shadow)**: 解决设备离线状态下的控制问题,提供设备状态缓存和同步机制
2. **边缘计算 (Edge Computing)**: 将部分计算和决策能力下沉到边缘端,降低延迟和云端负载

### 1.2 业务价值

**设备影子的价值:**
- 解决设备不稳定在线问题,即使设备离线也能下发控制指令
- 提供设备期望状态与实际状态的对比和同步机制
- 减少设备与云端的通信次数,优化网络带宽使用
- 提供设备状态的历史版本管理

**边缘计算的价值:**
- 降低数据传输延迟,实现实时响应(毫秒级)
- 减少云端计算负载和网络带宽消耗
- 提高系统可靠性,边缘端可独立运行
- 保护数据隐私,敏感数据可在本地处理
- 降低运营成本,减少云端资源消耗

### 1.3 应用场景

**设备影子典型场景:**

1. **智能家居场景**
   - 用户通过手机 APP 关闭家中的智能灯,但此时灯处于离线状态
   - 系统将期望状态保存到设备影子
   - 当灯重新上线后,自动同步期望状态并关闭

2. **工业设备控制**
   - 工厂需要在夜间调整设备参数,但设备此时处于离线维护状态
   - 将期望配置保存到影子
   - 设备恢复后自动应用新配置

3. **移动设备管理**
   - 车载设备在隧道中失去网络连接
   - 影子保持最新状态,设备恢复连接后快速同步

**边缘计算典型场景:**

1. **智能制造质检**
   - 工业相机实时拍摄产品图片
   - 边缘端运行 AI 模型进行质量检测
   - 只将异常产品信息上报云端,正常产品仅记录统计数据

2. **智慧交通路口控制**
   - 边缘网关实时处理路口摄像头数据
   - 本地完成车流量统计和信号灯控制决策
   - 低延迟响应(< 100ms),无需依赖云端

3. **能源监控与优化**
   - 边缘端实时监控电力设备运行状态
   - 本地执行能耗优化算法
   - 异常情况立即触发本地告警和控制

4. **视频监控与分析**
   - 边缘端进行人脸识别、行为分析
   - 只将关键事件和结果上传云端
   - 大幅降低带宽消耗

---

## 2. 设备影子 (Device Shadow) 详细需求

### 2.1 核心概念

**设备影子**是设备在云端的虚拟表示,包含设备的当前状态(reported state)和期望状态(desired state)。

#### 2.1.1 影子文档结构

```json
{
  "state": {
    "desired": {
      "color": "red",
      "temperature": 25,
      "power": true
    },
    "reported": {
      "color": "blue",
      "temperature": 22,
      "power": true
    },
    "delta": {
      "color": "red",
      "temperature": 25
    }
  },
  "metadata": {
    "desired": {
      "color": {
        "timestamp": 1700123456789
      },
      "temperature": {
        "timestamp": 1700123456789
      }
    },
    "reported": {
      "color": {
        "timestamp": 1700123400000
      },
      "temperature": {
        "timestamp": 1700123400000
      }
    }
  },
  "version": 15,
  "timestamp": 1700123456789
}
```

**字段说明:**
- **desired**: 期望状态(应用程序或用户期望设备达到的状态)
- **reported**: 上报状态(设备当前实际状态)
- **delta**: 差异(desired 与 reported 之间的差异)
- **metadata**: 元数据(每个属性的时间戳等信息)
- **version**: 版本号(每次更新递增)
- **timestamp**: 影子文档最后更新时间

### 2.2 功能需求

#### 2.2.1 影子文档管理

**F-SH-001: 创建设备影子**
- 当设备首次连接时,自动为设备创建影子文档
- 初始影子文档为空,version 为 0
- 支持手动为设备创建影子

**F-SH-002: 更新期望状态 (Update Desired)**
- 应用程序/用户可更新设备的期望状态
- 更新后,version 自动递增
- 如果设备在线,立即推送 delta 给设备
- 如果设备离线,等待设备上线后推送

**F-SH-003: 更新上报状态 (Update Reported)**
- 设备可上报当前实际状态
- 更新后,重新计算 delta
- version 自动递增

**F-SH-004: 获取设备影子**
- 支持查询完整影子文档
- 支持仅查询 desired 或 reported
- 支持查询 delta(需要同步的差异)

**F-SH-005: 删除影子属性**
- 支持删除 desired 中的特定属性
- 支持删除 reported 中的特定属性
- 支持清空整个影子文档

**F-SH-006: 影子版本控制**
- 每次影子更新,version 递增
- 支持基于版本号的条件更新(防止并发冲突)
- 支持查询历史版本(可配置保留数量)

#### 2.2.2 影子同步机制

**F-SH-007: 设备上线同步**
- 设备上线时,自动获取最新影子文档
- 如果存在 delta,设备需要同步期望状态
- 设备完成同步后,更新 reported 状态

**F-SH-008: 实时 Delta 推送**
- 当期望状态更新时,如果设备在线,立即推送 delta
- 设备接收 delta 后,执行状态变更
- 设备完成变更后,上报新的 reported 状态

**F-SH-009: 离线指令缓存**
- 设备离线时,期望状态更新会保存在影子中
- 设备上线后,自动拉取并应用期望状态
- 支持配置 delta 的有效期(过期自动清除)

**F-SH-010: 冲突解决策略**
- 当 desired 和 reported 存在冲突时,支持多种策略:
  - 以 desired 为准(默认)
  - 以 reported 为准
  - 基于时间戳
  - 自定义策略

#### 2.2.3 影子通信协议

**F-SH-011: MQTT Topic 规范**

| 操作 | Topic | 方向 | 说明 |
|------|-------|------|------|
| 获取影子 | `/shadow/{pk}/{dn}/get` | 设备→云端 | 设备请求获取影子 |
| 获取影子响应 | `/shadow/{pk}/{dn}/get/accepted` | 云端→设备 | 返回完整影子文档 |
| 更新影子 | `/shadow/{pk}/{dn}/update` | 双向 | 更新影子(desired 或 reported) |
| 更新成功响应 | `/shadow/{pk}/{dn}/update/accepted` | 云端→设备 | 更新成功 |
| 更新失败响应 | `/shadow/{pk}/{dn}/update/rejected` | 云端→设备 | 更新失败及原因 |
| Delta 推送 | `/shadow/{pk}/{dn}/update/delta` | 云端→设备 | 推送状态差异 |
| 删除影子 | `/shadow/{pk}/{dn}/delete` | 设备→云端 | 删除影子 |

**消息格式示例:**

```json
// 设备上报状态 (Update Reported)
{
  "method": "update",
  "state": {
    "reported": {
      "color": "red",
      "temperature": 25
    }
  },
  "version": 14
}

// 应用更新期望状态 (Update Desired)
{
  "method": "update",
  "state": {
    "desired": {
      "color": "blue",
      "power": false
    }
  },
  "version": 14
}

// Delta 推送给设备
{
  "method": "delta",
  "state": {
    "color": "blue",
    "power": false
  },
  "metadata": {
    "color": {
      "timestamp": 1700123456789
    },
    "power": {
      "timestamp": 1700123456789
    }
  },
  "version": 15
}

// 设备获取影子响应
{
  "method": "get",
  "state": {
    "desired": {
      "color": "blue",
      "power": false
    },
    "reported": {
      "color": "red",
      "power": true
    },
    "delta": {
      "color": "blue",
      "power": false
    }
  },
  "version": 15,
  "timestamp": 1700123456789
}
```

#### 2.2.4 影子数据存储

**F-SH-012: 存储策略**
- **MySQL**: 存储影子元数据(设备ID、版本号、最后更新时间等)
- **Redis**: 存储最新影子文档(JSON格式),快速读写
- **TDengine**: 存储影子变更历史(可选,用于审计和分析)

**F-SH-013: 数据过期策略**
- 支持配置影子文档的有效期
- 设备长期离线后,影子可设置为过期状态
- 过期影子在设备重新上线时重新激活

#### 2.2.5 影子权限控制

**F-SH-014: 访问权限**
- 支持基于角色的影子访问控制
- 设备只能访问自己的影子
- 应用程序需要相应权限才能更新影子
- 支持影子的读写分离权限

### 2.3 API 接口设计

#### 2.3.1 REST API

**1. 获取设备影子**
```
GET /admin-api/iot/device-shadow/get?deviceId={deviceId}
```

**2. 更新期望状态**
```
POST /admin-api/iot/device-shadow/update-desired
{
  "deviceId": 1001,
  "desired": {
    "color": "red",
    "temperature": 25
  }
}
```

**3. 查询影子历史版本**
```
GET /admin-api/iot/device-shadow/history?deviceId={deviceId}&limit=10
```

**4. 删除影子文档**
```
DELETE /admin-api/iot/device-shadow/delete?deviceId={deviceId}
```

**5. 批量获取设备影子**
```
POST /admin-api/iot/device-shadow/batch-get
{
  "deviceIds": [1001, 1002, 1003]
}
```

#### 2.3.2 设备端 API (MQTT)

**1. 获取影子**
```
Publish: /shadow/{pk}/{dn}/get
Payload: {"method": "get"}

Subscribe: /shadow/{pk}/{dn}/get/accepted
```

**2. 更新上报状态**
```
Publish: /shadow/{pk}/{dn}/update
Payload: {
  "method": "update",
  "state": {
    "reported": {
      "color": "red"
    }
  }
}

Subscribe: /shadow/{pk}/{dn}/update/accepted
```

**3. 订阅 Delta**
```
Subscribe: /shadow/{pk}/{dn}/update/delta
```

### 2.4 数据模型设计

#### 2.4.1 影子元数据表 (iot_device_shadow)

```sql
CREATE TABLE iot_device_shadow (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键',
    device_id BIGINT NOT NULL COMMENT '设备ID',
    product_id BIGINT NOT NULL COMMENT '产品ID',

    -- 影子状态
    desired_state JSON COMMENT '期望状态',
    reported_state JSON COMMENT '上报状态',
    delta_state JSON COMMENT '差异状态',

    -- 元数据
    metadata JSON COMMENT '元数据(时间戳等)',
    version INT NOT NULL DEFAULT 0 COMMENT '版本号',

    -- 同步状态
    sync_status TINYINT NOT NULL DEFAULT 0 COMMENT '同步状态: 0=已同步, 1=待同步',
    last_sync_time DATETIME COMMENT '最后同步时间',

    -- 有效期
    expire_time DATETIME COMMENT '过期时间',
    status TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0=禁用, 1=启用, 2=过期',

    -- 标准字段
    creator VARCHAR(64) DEFAULT '' COMMENT '创建者',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updater VARCHAR(64) DEFAULT '' COMMENT '更新者',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted BIT(1) NOT NULL DEFAULT 0 COMMENT '是否删除',
    tenant_id BIGINT NOT NULL DEFAULT 0 COMMENT '租户ID',

    UNIQUE KEY uk_device_id (device_id),
    INDEX idx_product_id (product_id),
    INDEX idx_sync_status (sync_status),
    INDEX idx_status (status)
) COMMENT='IoT 设备影子表';
```

#### 2.4.2 影子历史记录表 (iot_device_shadow_history)

```sql
CREATE TABLE iot_device_shadow_history (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键',
    shadow_id BIGINT NOT NULL COMMENT '影子ID',
    device_id BIGINT NOT NULL COMMENT '设备ID',

    -- 变更信息
    operation_type VARCHAR(20) NOT NULL COMMENT '操作类型: UPDATE_DESIRED, UPDATE_REPORTED, DELETE',
    change_type VARCHAR(20) NOT NULL COMMENT '变更类型: DESIRED, REPORTED, BOTH',

    -- 变更前后数据
    before_state JSON COMMENT '变更前状态',
    after_state JSON COMMENT '变更后状态',

    -- 版本信息
    version_before INT COMMENT '变更前版本号',
    version_after INT COMMENT '变更后版本号',

    -- 操作信息
    operator_type VARCHAR(20) NOT NULL COMMENT '操作者类型: DEVICE, USER, SYSTEM',
    operator_id VARCHAR(64) COMMENT '操作者ID',

    -- 标准字段
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    tenant_id BIGINT NOT NULL DEFAULT 0 COMMENT '租户ID',

    INDEX idx_shadow_id (shadow_id),
    INDEX idx_device_id (device_id),
    INDEX idx_create_time (create_time)
) COMMENT='IoT 设备影子历史记录表';
```

### 2.5 非功能性需求

#### 2.5.1 性能要求

- **影子文档大小限制**: 单个影子文档不超过 64KB
- **影子更新延迟**: 在线设备收到 delta 延迟 < 500ms
- **并发更新**: 支持每秒 1000+ 次影子更新操作
- **查询性能**: 影子查询响应时间 < 100ms

#### 2.5.2 可靠性要求

- **数据一致性**: 保证影子文档的最终一致性
- **版本冲突处理**: 支持乐观锁机制防止并发冲突
- **数据持久化**: Redis + MySQL 双重存储保证数据安全

#### 2.5.3 可扩展性要求

- 支持百万级设备影子
- 支持水平扩展 Redis 集群
- 支持影子文档的自定义字段

---

## 3. 边缘计算 (Edge Computing) 详细需求

### 3.1 核心概念

**边缘计算**是在靠近数据源的网络边缘侧提供计算、存储、网络等资源,实现数据的就近处理和实时响应。

#### 3.1.1 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                      云端平台 (Cloud)                    │
│  - 设备管理                                               │
│  - 边缘管理                                               │
│  - 数据存储与分析                                         │
│  - 规则配置下发                                           │
│  - 模型管理与分发                                         │
└────────────────────┬───────────────────────────────────┘
                     │ MQTT/HTTP/WebSocket
                     │ (规则下发、数据上报、远程管理)
┌────────────────────▼───────────────────────────────────┐
│                  边缘网关 (Edge Gateway)                 │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 边缘计算引擎                                      │   │
│  │ - 规则引擎 (本地执行)                             │   │
│  │ - 流式计算 (实时数据处理)                         │   │
│  │ - AI 推理 (模型本地运行)                          │   │
│  │ - 数据聚合与过滤                                  │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 本地数据存储                                      │   │
│  │ - 时序数据缓存 (SQLite/InfluxDB)                 │   │
│  │ - 配置缓存                                        │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 设备协议适配                                      │   │
│  │ - MQTT, Modbus, OPC UA, BACnet                   │   │
│  └─────────────────────────────────────────────────┘   │
└────────────────────┬───────────────────────────────────┘
                     │ Modbus/OPC UA/MQTT
                     │ (设备数据采集、控制)
┌────────────────────▼───────────────────────────────────┐
│                    终端设备 (Devices)                    │
│  - 传感器、执行器、工业设备、智能设备                    │
└──────────────────────────────────────────────────────────┘
```

### 3.2 功能需求

#### 3.2.1 边缘网关管理

**F-EC-001: 边缘网关注册**
- 支持边缘网关向云端注册
- 网关信息: 名称、序列号、硬件配置、网络信息
- 自动生成网关密钥用于认证
- 支持批量导入网关

**F-EC-002: 网关状态监控**
- 实时监控网关在线/离线状态
- 监控网关资源使用情况(CPU、内存、磁盘、网络)
- 监控网关连接的设备数量
- 网关异常告警

**F-EC-003: 网关远程管理**
- 远程重启网关
- 远程更新网关配置
- 远程查看网关日志
- 远程终端访问(SSH over MQTT)

**F-EC-004: 网关 OTA 升级**
- 支持网关软件远程升级
- 支持分批次升级
- 升级进度监控
- 升级回滚机制

#### 3.2.2 设备接入管理

**F-EC-005: 子设备管理**
- 边缘网关作为网关设备,可管理多个子设备
- 子设备通过边缘网关连接到云端
- 支持子设备上线/离线通知
- 支持子设备拓扑关系管理

**F-EC-006: 协议转换**
- 边缘网关支持多种工业协议(Modbus、OPC UA、BACnet等)
- 协议数据自动转换为标准物模型格式
- 支持自定义协议插件

**F-EC-007: 数据采集配置**
- 配置子设备的数据采集频率
- 配置数据过滤规则(只上传变化值、超过阈值等)
- 配置数据聚合策略(求平均、求和、最大值等)

#### 3.2.3 边缘规则引擎

**F-EC-008: 规则下发**
- 云端配置规则,下发到边缘网关
- 规则包含: 触发条件、执行动作
- 支持规则的启用/禁用
- 支持规则优先级

**F-EC-009: 本地规则执行**
- 边缘网关本地执行规则,无需云端参与
- 支持基于设备属性的条件判断
- 支持时间条件(定时、周期)
- 支持复杂条件组合(AND、OR、NOT)

**F-EC-010: 规则动作类型**
- **设备控制**: 控制子设备属性或服务
- **数据转发**: 将数据转发到其他设备或系统
- **本地告警**: 触发本地告警(声光报警器、短信等)
- **数据上报**: 将特定数据上报云端

**示例规则:**
```json
{
  "ruleId": "rule_001",
  "name": "温度异常控制",
  "status": 1,
  "trigger": {
    "type": "PROPERTY_CHANGE",
    "deviceId": "sensor_001",
    "identifier": "temperature",
    "operator": "GREATER_THAN",
    "value": 80
  },
  "conditions": [
    {
      "deviceId": "sensor_001",
      "identifier": "humidity",
      "operator": "LESS_THAN",
      "value": 30
    }
  ],
  "actions": [
    {
      "type": "DEVICE_CONTROL",
      "deviceId": "fan_001",
      "identifier": "power",
      "value": true
    },
    {
      "type": "ALERT",
      "level": "HIGH",
      "message": "温度过高且湿度过低"
    },
    {
      "type": "REPORT_TO_CLOUD",
      "dataPoints": ["temperature", "humidity"]
    }
  ],
  "executeLocal": true
}
```

#### 3.2.4 边缘数据处理

**F-EC-011: 流式数据处理**
- 支持实时数据流处理
- 支持时间窗口聚合(滑动窗口、滚动窗口)
- 支持数据去重、过滤、转换

**F-EC-012: 数据缓存**
- 边缘网关本地缓存设备数据
- 网络断开时,数据持续缓存
- 网络恢复后,自动上传缓存数据
- 支持缓存容量限制和过期策略

**F-EC-013: 数据压缩与优化**
- 数据批量上传,减少网络请求
- 数据压缩传输
- 智能过滤(只上传变化值、异常值)

#### 3.2.5 边缘 AI 推理

**F-EC-014: 模型管理**
- 云端管理 AI 模型(训练、版本管理)
- 模型下发到边缘网关
- 支持多种模型格式(ONNX、TensorFlow Lite、PyTorch Mobile)

**F-EC-015: 本地推理**
- 边缘网关本地运行 AI 模型
- 实时图像识别、异常检测
- 推理结果本地处理或上报云端

**F-EC-016: 模型更新**
- 支持模型热更新(无需重启网关)
- 支持 A/B 测试(同时运行多个模型版本)
- 支持模型回滚

**应用示例:**
- **工业质检**: 边缘端实时检测产品缺陷
- **人脸识别**: 本地识别人脸,只上传识别结果
- **设备预测性维护**: 本地分析设备运行数据,预测故障

#### 3.2.6 边缘与云端协同

**F-EC-017: 云边协同**
- 云端统一管理边缘网关和规则
- 边缘网关自主运行,云端监控和调度
- 边缘数据聚合后上报云端
- 云端下发控制指令到边缘

**F-EC-018: 离线自治**
- 边缘网关在云端不可达时,继续独立运行
- 本地执行规则和控制逻辑
- 网络恢复后,同步状态到云端

**F-EC-019: 数据分层存储**
- **边缘层**: 存储实时数据、缓存数据
- **云端**: 存储历史数据、聚合数据
- 根据重要性和访问频率智能分配存储

### 3.3 边缘网关软件架构

#### 3.3.1 技术栈选择

**方案一: Java 边缘网关 (基于 Spring Boot)**
- **优点**: 与云端技术栈一致,易于维护
- **缺点**: 资源占用较高,适合高性能边缘设备
- **适用场景**: 工业网关、边缘服务器

**方案二: Go 边缘网关**
- **优点**: 轻量级,资源占用低,跨平台
- **缺点**: 需要单独维护
- **适用场景**: 资源受限的边缘设备

**方案三: Python 边缘网关**
- **优点**: AI 生态丰富,开发效率高
- **缺点**: 性能相对较低
- **适用场景**: AI 推理场景

**推荐方案**: Java (与云端统一) + 轻量级运行时(GraalVM Native Image)

#### 3.3.2 核心组件

```
边缘网关核心组件:
├── 设备协议适配层
│   ├── MQTT Client
│   ├── Modbus Master
│   ├── OPC UA Client
│   └── 自定义协议插件
├── 数据处理引擎
│   ├── 规则引擎
│   ├── 流式计算引擎
│   └── 数据聚合器
├── AI 推理引擎
│   ├── ONNX Runtime
│   ├── TensorFlow Lite
│   └── 模型管理器
├── 本地存储
│   ├── SQLite (元数据)
│   ├── InfluxDB (时序数据)
│   └── 文件缓存
├── 云端通信层
│   ├── MQTT 连接管理
│   ├── 数据上报
│   └── 指令接收
└── 管理与监控
    ├── 资源监控
    ├── 日志管理
    └── 远程管理接口
```

### 3.4 API 接口设计

#### 3.4.1 云端 REST API

**1. 创建边缘网关**
```
POST /admin-api/iot/edge-gateway/create
{
  "name": "工厂1号网关",
  "serialNumber": "EDGE-GW-001",
  "description": "一号车间边缘网关",
  "location": "车间A区"
}
```

**2. 查询边缘网关列表**
```
GET /admin-api/iot/edge-gateway/page?pageNo=1&pageSize=10
```

**3. 更新网关配置**
```
PUT /admin-api/iot/edge-gateway/update-config
{
  "id": 1001,
  "config": {
    "dataCacheDays": 7,
    "uploadInterval": 60,
    "logLevel": "INFO"
  }
}
```

**4. 下发边缘规则**
```
POST /admin-api/iot/edge-rule/deploy
{
  "gatewayId": 1001,
  "ruleId": 2001
}
```

**5. 查询网关状态**
```
GET /admin-api/iot/edge-gateway/status?id=1001
```

#### 3.4.2 边缘网关 MQTT 通信协议

**Topic 规范:**

| 操作 | Topic | 方向 | 说明 |
|------|-------|------|------|
| 网关注册 | `/edge/register` | 网关→云端 | 网关注册 |
| 网关心跳 | `/edge/{gatewayId}/heartbeat` | 网关→云端 | 定期心跳 |
| 规则下发 | `/edge/{gatewayId}/rule/deploy` | 云端→网关 | 下发边缘规则 |
| 规则删除 | `/edge/{gatewayId}/rule/delete` | 云端→网关 | 删除边缘规则 |
| 配置更新 | `/edge/{gatewayId}/config/update` | 云端→网关 | 更新网关配置 |
| 数据上报 | `/edge/{gatewayId}/data/report` | 网关→云端 | 上报聚合数据 |
| 告警上报 | `/edge/{gatewayId}/alert/report` | 网关→云端 | 上报告警 |
| 远程控制 | `/edge/{gatewayId}/control` | 云端→网关 | 远程控制指令 |

**消息格式示例:**

```json
// 网关心跳
{
  "method": "heartbeat",
  "timestamp": 1700123456789,
  "status": {
    "cpuUsage": 35.5,
    "memoryUsage": 60.2,
    "diskUsage": 45.0,
    "onlineDeviceCount": 25
  }
}

// 规则下发
{
  "method": "rule.deploy",
  "ruleId": "rule_001",
  "rule": {
    "name": "温度异常控制",
    "trigger": {...},
    "actions": [...]
  }
}

// 数据上报
{
  "method": "data.report",
  "timestamp": 1700123456789,
  "data": [
    {
      "deviceId": "sensor_001",
      "identifier": "temperature",
      "value": 25.5,
      "timestamp": 1700123456000
    }
  ]
}
```

### 3.5 数据模型设计

#### 3.5.1 边缘网关表 (iot_edge_gateway)

```sql
CREATE TABLE iot_edge_gateway (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键',
    name VARCHAR(100) NOT NULL COMMENT '网关名称',
    serial_number VARCHAR(64) NOT NULL COMMENT '网关序列号',
    gateway_key VARCHAR(64) NOT NULL COMMENT '网关标识',
    gateway_secret VARCHAR(128) NOT NULL COMMENT '网关密钥',

    -- 设备信息
    device_type VARCHAR(50) COMMENT '设备型号',
    hardware_version VARCHAR(50) COMMENT '硬件版本',
    software_version VARCHAR(50) COMMENT '软件版本',

    -- 网络信息
    ip_address VARCHAR(50) COMMENT 'IP地址',
    mac_address VARCHAR(50) COMMENT 'MAC地址',
    location VARCHAR(200) COMMENT '安装位置',

    -- 状态信息
    status TINYINT NOT NULL DEFAULT 0 COMMENT '状态: 0=未激活, 1=在线, 2=离线',
    last_online_time DATETIME COMMENT '最后在线时间',
    last_offline_time DATETIME COMMENT '最后离线时间',

    -- 资源信息
    cpu_cores INT COMMENT 'CPU核心数',
    memory_total INT COMMENT '总内存(MB)',
    disk_total INT COMMENT '总磁盘(GB)',

    -- 配置信息
    config JSON COMMENT '网关配置',
    description VARCHAR(500) COMMENT '描述',

    -- 标准字段
    creator VARCHAR(64) DEFAULT '' COMMENT '创建者',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updater VARCHAR(64) DEFAULT '' COMMENT '更新者',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted BIT(1) NOT NULL DEFAULT 0 COMMENT '是否删除',
    tenant_id BIGINT NOT NULL DEFAULT 0 COMMENT '租户ID',

    UNIQUE KEY uk_serial_number (serial_number),
    UNIQUE KEY uk_gateway_key (gateway_key),
    INDEX idx_status (status)
) COMMENT='IoT 边缘网关表';
```

#### 3.5.2 边缘规则表 (iot_edge_rule)

```sql
CREATE TABLE iot_edge_rule (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键',
    name VARCHAR(100) NOT NULL COMMENT '规则名称',
    gateway_id BIGINT NOT NULL COMMENT '网关ID',

    -- 规则配置
    rule_type VARCHAR(20) NOT NULL COMMENT '规则类型: SCENE, DATA_FLOW, AI_INFERENCE',
    trigger_config JSON NOT NULL COMMENT '触发器配置',
    condition_config JSON COMMENT '条件配置',
    action_config JSON NOT NULL COMMENT '动作配置',

    -- 执行配置
    execute_local TINYINT NOT NULL DEFAULT 1 COMMENT '是否本地执行: 0=否, 1=是',
    priority INT DEFAULT 0 COMMENT '优先级',

    -- 状态信息
    status TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0=禁用, 1=启用',
    deploy_status TINYINT NOT NULL DEFAULT 0 COMMENT '部署状态: 0=未部署, 1=已部署, 2=部署失败',
    deploy_time DATETIME COMMENT '部署时间',

    -- 统计信息
    execute_count BIGINT DEFAULT 0 COMMENT '执行次数',
    last_execute_time DATETIME COMMENT '最后执行时间',

    -- 标准字段
    creator VARCHAR(64) DEFAULT '' COMMENT '创建者',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updater VARCHAR(64) DEFAULT '' COMMENT '更新者',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted BIT(1) NOT NULL DEFAULT 0 COMMENT '是否删除',
    tenant_id BIGINT NOT NULL DEFAULT 0 COMMENT '租户ID',

    INDEX idx_gateway_id (gateway_id),
    INDEX idx_status (status),
    INDEX idx_deploy_status (deploy_status)
) COMMENT='IoT 边缘规则表';
```

#### 3.5.3 边缘网关状态表 (iot_edge_gateway_status)

```sql
CREATE TABLE iot_edge_gateway_status (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键',
    gateway_id BIGINT NOT NULL COMMENT '网关ID',

    -- 资源使用情况
    cpu_usage DECIMAL(5,2) COMMENT 'CPU使用率(%)',
    memory_usage DECIMAL(5,2) COMMENT '内存使用率(%)',
    disk_usage DECIMAL(5,2) COMMENT '磁盘使用率(%)',
    network_upload_speed INT COMMENT '网络上传速度(KB/s)',
    network_download_speed INT COMMENT '网络下载速度(KB/s)',

    -- 设备统计
    online_device_count INT DEFAULT 0 COMMENT '在线设备数',
    total_device_count INT DEFAULT 0 COMMENT '总设备数',

    -- 规则统计
    active_rule_count INT DEFAULT 0 COMMENT '活跃规则数',
    rule_execute_count INT DEFAULT 0 COMMENT '规则执行次数',

    -- 数据统计
    data_receive_count BIGINT DEFAULT 0 COMMENT '接收数据条数',
    data_upload_count BIGINT DEFAULT 0 COMMENT '上传数据条数',

    -- 时间信息
    record_time DATETIME NOT NULL COMMENT '记录时间',

    INDEX idx_gateway_id (gateway_id),
    INDEX idx_record_time (record_time)
) COMMENT='IoT 边缘网关状态表';
```

#### 3.5.4 AI 模型表 (iot_edge_ai_model)

```sql
CREATE TABLE iot_edge_ai_model (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键',
    name VARCHAR(100) NOT NULL COMMENT '模型名称',
    version VARCHAR(50) NOT NULL COMMENT '模型版本',

    -- 模型信息
    model_type VARCHAR(50) NOT NULL COMMENT '模型类型: IMAGE_CLASSIFICATION, OBJECT_DETECTION, ANOMALY_DETECTION',
    model_format VARCHAR(20) NOT NULL COMMENT '模型格式: ONNX, TENSORFLOW_LITE, PYTORCH',
    file_url VARCHAR(500) NOT NULL COMMENT '模型文件URL',
    file_size BIGINT COMMENT '文件大小(字节)',
    file_md5 VARCHAR(32) COMMENT '文件MD5',

    -- 运行要求
    min_memory INT COMMENT '最小内存要求(MB)',
    min_cpu_cores INT COMMENT '最小CPU核心数',
    gpu_required TINYINT DEFAULT 0 COMMENT '是否需要GPU: 0=否, 1=是',

    -- 应用场景
    application_scene VARCHAR(200) COMMENT '应用场景',
    input_format VARCHAR(100) COMMENT '输入格式',
    output_format VARCHAR(100) COMMENT '输出格式',

    -- 状态信息
    status TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0=禁用, 1=启用',
    description VARCHAR(500) COMMENT '描述',

    -- 标准字段
    creator VARCHAR(64) DEFAULT '' COMMENT '创建者',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updater VARCHAR(64) DEFAULT '' COMMENT '更新者',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted BIT(1) NOT NULL DEFAULT 0 COMMENT '是否删除',
    tenant_id BIGINT NOT NULL DEFAULT 0 COMMENT '租户ID',

    INDEX idx_model_type (model_type),
    INDEX idx_status (status)
) COMMENT='IoT 边缘 AI 模型表';
```

#### 3.5.5 模型部署记录表 (iot_edge_model_deployment)

```sql
CREATE TABLE iot_edge_model_deployment (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '主键',
    model_id BIGINT NOT NULL COMMENT '模型ID',
    gateway_id BIGINT NOT NULL COMMENT '网关ID',

    -- 部署信息
    deploy_status TINYINT NOT NULL DEFAULT 0 COMMENT '部署状态: 0=未部署, 1=已部署, 2=部署失败',
    deploy_time DATETIME COMMENT '部署时间',
    deploy_error VARCHAR(500) COMMENT '部署错误信息',

    -- 运行信息
    status TINYINT NOT NULL DEFAULT 1 COMMENT '状态: 0=停止, 1=运行中',
    start_time DATETIME COMMENT '启动时间',
    stop_time DATETIME COMMENT '停止时间',

    -- 性能统计
    inference_count BIGINT DEFAULT 0 COMMENT '推理次数',
    avg_inference_time INT COMMENT '平均推理时间(ms)',
    last_inference_time DATETIME COMMENT '最后推理时间',

    -- 标准字段
    creator VARCHAR(64) DEFAULT '' COMMENT '创建者',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updater VARCHAR(64) DEFAULT '' COMMENT '更新者',
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted BIT(1) NOT NULL DEFAULT 0 COMMENT '是否删除',
    tenant_id BIGINT NOT NULL DEFAULT 0 COMMENT '租户ID',

    INDEX idx_model_id (model_id),
    INDEX idx_gateway_id (gateway_id),
    INDEX idx_deploy_status (deploy_status)
) COMMENT='IoT 边缘模型部署记录表';
```

### 3.6 非功能性需求

#### 3.6.1 性能要求

- **数据处理延迟**: 边缘规则执行延迟 < 50ms
- **AI 推理延迟**: 图像推理延迟 < 200ms
- **数据吞吐量**: 单个网关支持 1000+ 数据点/秒
- **设备接入**: 单个网关支持 100+ 子设备

#### 3.6.2 可靠性要求

- **离线自治**: 网关在云端不可达时,持续运行 7 天以上
- **数据不丢失**: 本地缓存机制保证数据不丢失
- **故障恢复**: 网关故障重启后,自动恢复运行状态

#### 3.6.3 可扩展性要求

- 支持插件化协议扩展
- 支持自定义规则动作
- 支持多种 AI 模型格式

#### 3.6.4 安全性要求

- **认证**: 网关与云端双向认证
- **加密**: 数据传输 TLS 加密
- **权限**: 网关只能访问授权的设备和资源

---

## 4. 实施计划

### 4.1 开发阶段划分

#### 第一阶段: 设备影子基础功能 (2-3 周)

**目标**: 实现基本的设备影子功能

**任务:**
1. 数据库表设计与创建
2. 影子文档数据模型定义
3. 影子 CRUD 接口实现
4. 影子同步机制实现
5. MQTT 协议支持
6. 基础单元测试

**交付物:**
- 影子管理 REST API
- 影子 MQTT 通信协议
- 基础功能演示

#### 第二阶段: 设备影子高级功能 (1-2 周)

**目标**: 完善设备影子功能

**任务:**
1. 版本控制与冲突解决
2. 历史版本查询
3. 批量操作支持
4. 权限控制
5. 性能优化
6. 前端界面开发

**交付物:**
- 完整设备影子功能
- 前端管理界面
- 性能测试报告

#### 第三阶段: 边缘网关基础功能 (3-4 周)

**目标**: 实现边缘网关核心功能

**任务:**
1. 边缘网关数据模型设计
2. 网关注册与认证
3. 网关状态监控
4. 子设备管理
5. 云边通信协议实现
6. 边缘规则引擎开发

**交付物:**
- 边缘网关管理 API
- 边缘规则引擎
- 网关监控界面

#### 第四阶段: 边缘计算高级功能 (3-4 周)

**目标**: 实现边缘数据处理和 AI 推理

**任务:**
1. 流式数据处理引擎
2. 数据缓存与上传
3. AI 模型管理
4. 边缘 AI 推理引擎
5. 协议适配器扩展
6. 性能优化

**交付物:**
- 完整边缘计算功能
- AI 推理演示
- 性能测试报告

#### 第五阶段: 集成测试与优化 (1-2 周)

**目标**: 系统集成测试和优化

**任务:**
1. 端到端集成测试
2. 压力测试
3. 安全性测试
4. Bug 修复
5. 文档完善
6. 部署指南编写

**交付物:**
- 测试报告
- 部署文档
- 用户手册

### 4.2 技术风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 边缘网关开发复杂度高 | 延期 | 采用模块化设计,优先实现核心功能 |
| 性能不达标 | 用户体验差 | 提前进行性能测试,优化关键路径 |
| 设备兼容性问题 | 功能受限 | 充分调研设备协议,提供扩展机制 |
| 数据一致性问题 | 数据错误 | 设计合理的数据同步机制,增加校验 |

### 4.3 资源需求

**人力资源:**
- 后端开发: 2 人
- 前端开发: 1 人
- 测试: 1 人
- 架构设计: 1 人(兼职)

**硬件资源:**
- 边缘网关测试设备: 2-3 台
- 测试用传感器设备: 5-10 个
- 服务器环境: 云端开发测试环境

**时间估算:**
- 总开发周期: 10-15 周
- 关键路径: 边缘规则引擎 + AI 推理引擎

---

## 5. 附录

### 5.1 参考资料

**设备影子:**
- AWS IoT Device Shadow: https://docs.aws.amazon.com/iot/latest/developerguide/iot-device-shadows.html
- Azure IoT Hub Device Twins: https://learn.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-device-twins
- 阿里云物模型: https://help.aliyun.com/document_detail/88241.html

**边缘计算:**
- AWS IoT Greengrass: https://aws.amazon.com/greengrass/
- Azure IoT Edge: https://azure.microsoft.com/en-us/products/iot-edge/
- KubeEdge: https://kubeedge.io/
- EdgeX Foundry: https://www.edgexfoundry.org/

### 5.2 术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 设备影子 | Device Shadow | 设备在云端的虚拟表示 |
| 期望状态 | Desired State | 应用程序期望设备达到的状态 |
| 上报状态 | Reported State | 设备当前实际状态 |
| 差异 | Delta | 期望状态与上报状态的差异 |
| 边缘计算 | Edge Computing | 在网络边缘进行数据处理和计算 |
| 边缘网关 | Edge Gateway | 连接设备和云端的边缘计算节点 |
| 规则引擎 | Rule Engine | 基于规则自动执行动作的引擎 |
| AI 推理 | AI Inference | 使用训练好的模型进行预测 |
| 云边协同 | Cloud-Edge Collaboration | 云端和边缘端协同工作 |
| 离线自治 | Offline Autonomy | 离线状态下独立运行 |

### 5.3 示例代码

#### 5.3.1 设备影子更新示例 (Java)

```java
// 更新期望状态
@PostMapping("/update-desired")
public CommonResult<Boolean> updateDesired(@RequestBody UpdateDesiredReqVO reqVO) {
    // 构建期望状态
    Map<String, Object> desired = reqVO.getDesired();

    // 更新影子
    deviceShadowService.updateDesired(reqVO.getDeviceId(), desired);

    return success(true);
}

// 影子服务实现
@Service
public class DeviceShadowServiceImpl implements DeviceShadowService {

    @Override
    @Transactional
    public void updateDesired(Long deviceId, Map<String, Object> desired) {
        // 1. 获取当前影子
        IotDeviceShadowDO shadow = shadowMapper.selectByDeviceId(deviceId);
        if (shadow == null) {
            shadow = createDefaultShadow(deviceId);
        }

        // 2. 合并期望状态
        Map<String, Object> currentDesired = shadow.getDesiredState();
        currentDesired.putAll(desired);

        // 3. 计算 delta
        Map<String, Object> reported = shadow.getReportedState();
        Map<String, Object> delta = calculateDelta(currentDesired, reported);

        // 4. 更新影子文档
        shadow.setDesiredState(currentDesired);
        shadow.setDeltaState(delta);
        shadow.setVersion(shadow.getVersion() + 1);
        shadow.setSyncStatus(delta.isEmpty() ? 0 : 1);
        shadowMapper.updateById(shadow);

        // 5. 更新 Redis 缓存
        shadowRedisDao.set(deviceId, shadow);

        // 6. 如果设备在线,推送 delta
        if (isDeviceOnline(deviceId)) {
            pushDeltaToDevice(deviceId, delta, shadow.getVersion());
        }
    }
}
```

#### 5.3.2 边缘规则执行示例 (Java)

```java
// 边缘规则引擎
@Component
public class EdgeRuleEngine {

    public void executeRule(IotEdgeRuleDO rule, Map<String, Object> context) {
        // 1. 检查触发条件
        if (!checkTrigger(rule.getTriggerConfig(), context)) {
            return;
        }

        // 2. 检查附加条件
        if (!checkConditions(rule.getConditionConfig(), context)) {
            return;
        }

        // 3. 执行动作
        List<Map<String, Object>> actions = rule.getActionConfig();
        for (Map<String, Object> action : actions) {
            executeAction(action, context);
        }

        // 4. 更新统计
        updateRuleStatistics(rule.getId());
    }

    private void executeAction(Map<String, Object> action, Map<String, Object> context) {
        String actionType = (String) action.get("type");

        switch (actionType) {
            case "DEVICE_CONTROL":
                controlDevice(action);
                break;
            case "ALERT":
                triggerAlert(action);
                break;
            case "REPORT_TO_CLOUD":
                reportToCloud(action, context);
                break;
            default:
                log.warn("未知的动作类型: {}", actionType);
        }
    }
}
```

---

## 6. 总结

本需求分析文档详细描述了 HR-IoT 平台的设备影子和边缘计算功能需求,包括:

1. **设备影子功能**: 提供完整的设备状态管理和同步机制,解决设备离线控制问题
2. **边缘计算功能**: 实现边缘网关管理、本地规则执行、AI 推理等高级功能

**核心价值:**
- 提升系统可靠性和实时性
- 降低云端负载和网络带宽消耗
- 支持离线自治,增强系统鲁棒性
- 为工业互联网、智能制造等场景提供强大支持

**下一步工作:**
1. 评审需求文档,确认技术方案
2. 细化数据库设计
3. 启动第一阶段开发
4. 搭建开发测试环境

---

**文档状态**: 初稿待审核
**审核人**: 待指定
**审核日期**: 待定
