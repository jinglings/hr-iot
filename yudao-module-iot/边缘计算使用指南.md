# 边缘计算模块使用指南

## 模块概述

边缘计算模块实现了完整的云边协同架构，支持边缘网关管理、规则引擎、AI模型部署等功能。

## 核心功能

### 1. 边缘网关管理
- 网关注册与认证
- 网关状态监控（CPU、内存、磁盘使用率）
- 网关在线/离线管理
- 心跳上报处理

### 2. 边缘规则引擎
- 场景联动规则
- 数据流转规则
- AI推理规则
- 规则下发到边缘网关
- 规则执行结果上报

### 3. 边缘AI模型
- AI模型管理（CRUD）
- 模型部署到网关
- 模型启动/停止
- 支持多种模型格式（ONNX、TensorFlow Lite）

## API使用示例

### 1. 创建边缘网关

```http
POST /iot/edge-gateway/create
Content-Type: application/json

{
  "name": "工厂车间网关01",
  "serialNumber": "GW-2024-001",
  "location": "一号车间",
  "description": "生产线边缘网关"
}
```

响应示例：
```json
{
  "code": 0,
  "data": 1,
  "msg": "成功"
}
```

系统会自动生成：
- `gatewayKey`: 网关标识（如：EDG-ABC123）
- `gatewaySecret`: 网关密钥（用于认证）

### 2. 创建边缘规则

```http
POST /iot/edge-rule/create
Content-Type: application/json

{
  "name": "温度告警规则",
  "gatewayId": 1,
  "ruleType": 1,
  "ruleConfig": {
    "conditions": {
      "operator": "AND",
      "conditions": [
        {
          "property": "temperature",
          "comparator": ">",
          "value": 30
        },
        {
          "property": "humidity",
          "comparator": "<",
          "value": 40
        }
      ]
    },
    "actions": [
      {
        "type": "ALERT",
        "level": "HIGH",
        "message": "温度过高且湿度过低"
      },
      {
        "type": "DEVICE_CONTROL",
        "deviceId": "fan_001",
        "identifier": "power",
        "value": true
      }
    ]
  },
  "description": "当温度超过30度且湿度低于40%时，发送告警并开启风扇"
}
```

### 3. 部署规则到网关

```http
POST /iot/edge-rule/deploy?id=1
```

系统会：
1. 校验规则存在
2. 校验网关在线
3. 更新部署状态为"部署中"
4. 发送规则配置到边缘网关（通过消息总线）

### 4. 创建和部署AI模型

```http
POST /iot/edge-ai-model/create
Content-Type: application/json

{
  "name": "质量检测模型",
  "version": "v1.0.0",
  "modelType": "目标检测",
  "modelFormat": "ONNX",
  "modelUrl": "http://model-storage.com/quality_detect_v1.onnx",
  "description": "产品质量检测AI模型"
}
```

部署模型到网关：
```http
POST /iot/edge-model-deployment/deploy?modelId=1&gatewayId=1
```

## 规则配置示例

### 1. 简单条件规则

```json
{
  "conditions": {
    "property": "temperature",
    "comparator": ">",
    "value": 50
  },
  "actions": [
    {
      "type": "ALERT",
      "level": "CRITICAL",
      "message": "温度超过阈值！"
    }
  ]
}
```

### 2. AND逻辑规则

```json
{
  "conditions": {
    "operator": "AND",
    "conditions": [
      {"property": "temperature", "comparator": ">", "value": 30},
      {"property": "humidity", "comparator": "<", "value": 40}
    ]
  },
  "actions": [
    {"type": "ALERT", "level": "HIGH", "message": "环境异常"}
  ]
}
```

### 3. OR逻辑规则

```json
{
  "conditions": {
    "operator": "OR",
    "conditions": [
      {"property": "temperature", "comparator": ">", "value": 60},
      {"property": "pressure", "comparator": "<", "value": 10}
    ]
  },
  "actions": [
    {"type": "ALERT", "level": "CRITICAL", "message": "设备异常"}
  ]
}
```

### 4. 多动作规则

```json
{
  "conditions": {
    "property": "smoke_detected",
    "comparator": "==",
    "value": true
  },
  "actions": [
    {
      "type": "ALERT",
      "level": "CRITICAL",
      "message": "检测到烟雾！"
    },
    {
      "type": "DEVICE_CONTROL",
      "deviceId": "sprinkler_001",
      "identifier": "power",
      "value": true
    },
    {
      "type": "REPORT_TO_CLOUD",
      "dataPoints": ["smoke_detected", "temperature", "location"]
    }
  ]
}
```

## 支持的条件比较运算符

| 运算符 | 别名 | 说明 | 示例 |
|--------|------|------|------|
| EQ | == | 等于 | temperature == 25 |
| NE | != | 不等于 | status != "offline" |
| GT | > | 大于 | temperature > 30 |
| GTE | >= | 大于等于 | humidity >= 60 |
| LT | < | 小于 | pressure < 100 |
| LTE | <= | 小于等于 | battery <= 20 |
| CONTAINS | - | 包含 | error_msg CONTAINS "timeout" |

## 支持的动作类型

### 1. ALERT - 发送告警
```json
{
  "type": "ALERT",
  "level": "HIGH",  // CRITICAL, HIGH, MEDIUM, LOW
  "message": "告警消息"
}
```

### 2. DEVICE_CONTROL - 控制设备
```json
{
  "type": "DEVICE_CONTROL",
  "deviceId": "device_001",
  "identifier": "power",  // 属性标识符
  "value": true           // 目标值
}
```

### 3. REPORT_TO_CLOUD - 上报云端
```json
{
  "type": "REPORT_TO_CLOUD",
  "dataPoints": ["temperature", "humidity", "pressure"]
}
```

### 4. LOG - 记录日志
```json
{
  "type": "LOG",
  "level": "INFO",
  "message": "规则触发记录"
}
```

## 云边通信协议

### 消息主题

**上行消息（边缘网关 → 云端）：**
- `edge.gateway.heartbeat` - 网关心跳
- `edge.rule.execute.result` - 规则执行结果
- `edge.ai.inference.result` - AI推理结果

**下行消息（云端 → 边缘网关）：**
- `edge.rule.deploy` - 规则下发
- `edge.model.deploy` - AI模型下发
- `edge.gateway.control` - 网关控制

### 心跳消息格式

```json
{
  "gatewayKey": "EDG-ABC123",
  "serialNumber": "GW-2024-001",
  "status": 1,
  "cpuUsage": 45,
  "memoryUsage": 60,
  "diskUsage": 70,
  "onlineDeviceCount": 15,
  "runningRuleCount": 3,
  "version": "1.0.0",
  "heartbeatTime": "2025-01-17T10:30:00"
}
```

### 规则执行结果格式

```json
{
  "ruleId": 1,
  "gatewayKey": "EDG-ABC123",
  "executeTime": "2025-01-17T10:30:00",
  "executeStatus": 1,  // 1=成功, 2=失败
  "executeResult": "发送告警[HIGH]: 温度过高; 控制设备[fan_001]属性[power]=true",
  "errorMessage": null,
  "triggerData": "{\"temperature\": 35, \"humidity\": 30}"
}
```

## 规则引擎工作流程

```
1. 设备数据上报 → 2. 边缘网关接收 → 3. 规则引擎评估条件
                                           ↓
                            条件满足 ← 4. 执行动作 → 5. 记录日志
                                           ↓
                                    6. 上报执行结果到云端
```

## 部署架构

```
┌─────────────┐
│   云端平台   │ ← MQTT/HTTP → ┌─────────────┐
│  Rule CRUD  │               │  边缘网关     │
│ Model Deploy│               │ Rule Engine  │
└─────────────┘               │ AI Inference │
                              └─────────────┘
                                     ↓ Modbus/MQTT
                              ┌─────────────┐
                              │  IoT设备     │
                              │  传感器      │
                              └─────────────┘
```

## 开发扩展

### 1. 添加新的条件运算符

在 `RuleConditionEvaluator.java` 的 `compare()` 方法中添加：

```java
case "BETWEEN":
    // 实现区间判断逻辑
    return value >= min && value <= max;
```

### 2. 添加新的动作类型

在 `RuleActionExecutor.java` 的 `executeAction()` 方法中添加：

```java
case "SEND_EMAIL":
    return executeSendEmail(action);
```

### 3. 自定义消息订阅者

```java
@Component
public class MyEdgeMessageSubscriber implements IotMessageSubscriber<MyMessage> {

    @Override
    public String getTopic() {
        return "edge.custom.topic";
    }

    @Override
    public String getGroup() {
        return "my-custom-group";
    }

    @Override
    public void onMessage(MyMessage message) {
        // 处理消息
    }
}
```

## 常见问题

### Q1: 规则部署失败？
A: 检查：
1. 网关是否在线（status=1）
2. 规则配置JSON格式是否正确
3. 网关是否已启用

### Q2: 规则不执行？
A: 检查：
1. 规则状态是否为启用（status=1）
2. 部署状态是否为已部署（deployStatus=2）
3. 条件配置是否正确
4. 设备数据字段名称是否匹配

### Q3: AI模型部署失败？
A: 检查：
1. 模型是否已启用
2. 网关是否在线
3. 模型URL是否可访问
4. 模型格式是否匹配网关支持的格式

## 性能指标

- 规则评估延迟: < 10ms
- 支持并发规则数: 1000+/网关
- 心跳上报频率: 可配置（默认30秒）
- 消息吞吐量: 10000条/秒

## 安全考虑

1. **网关认证**: 使用gatewayKey + gatewaySecret双因素认证
2. **消息加密**: 支持TLS加密传输
3. **权限控制**: 所有API接口使用@PreAuthorize权限控制
4. **数据隔离**: 基于租户ID的数据隔离

## 后续规划

- [ ] 支持复杂事件处理（CEP）
- [ ] 支持时间窗口聚合
- [ ] 支持规则版本管理
- [ ] 支持规则A/B测试
- [ ] 支持可视化规则编辑器

---

**版本**: v1.0.0
**更新时间**: 2025-11-17
**作者**: AI Assistant
